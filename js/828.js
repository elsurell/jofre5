(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[828],{47119:(e,t,s)=>{"use strict";s.r(t),s.d(t,{BatchToggleBlurVisibilityCommand:()=>c,BlurToolChangeCommand:()=>a,BlurToolState:()=>i,HideBlursCommand:()=>d,NavigateToBlurCommand:()=>o,SetBlurBrushScaleCommand:()=>r,ShowBlursCommand:()=>u,ToggleBlurVisibilityCommand:()=>l,default:()=>As});var i,n=s(56063);class a extends n.m{constructor(e){super(),this.payload={state:e}}}a.id="BLUR_TOOL_CHANGE";class r extends n.m{constructor(e){super(),this.payload={scale:e}}}r.id="SET_BLUR_BRUSH_SCALE";class o extends n.m{constructor(e,t=!1){super(),this.payload={blur:e,resetBlurTool:t}}}o.id="NAVIGATE_TO_BLUR";class l extends n.m{constructor(e){super(),this.payload={id:e}}}l.id="TOGGLE_BLUR_VISIBILITY";class u extends n.m{constructor(...e){super(),this.payload={ids:e}}}u.id="SHOW_BLURS";class d extends n.m{constructor(...e){super(),this.payload={ids:e}}}d.id="HIDE_BLURS";class c extends n.m{constructor(e){super(),this.payload={ids:e}}}c.id="BATCH_TOGGLE_BLUR_VISIBILITY",function(e){e.OFF="off",e.IDLE="idle",e.PAINTING="painting",e.SUGGESTING="suggesting"}(i||(i={}));var h,g=s(81396),m=s(933),p=s(4763),b=s(34608),f=s(59491),v=s(31740),S=s(79242),B=s(59228),E=s(31971),C=s(32580),w=s(77543),y=s(35213),T=s(71772),x=s(57793),I=s(74094),D=s(945),A=s(33716),_=s(90512),R=s(43017),O=s(38063),L=s(90288),P=s(3835),k=s(32197),N=s(67781),M=s(27163),U=s(92257),G=s(2159),j=s(70593),F=s(59635),z=s(63511),V=s(72803),H=s(96783),Q=s(53257),W=s(95840),Y=s(11250),q=s(20348),Z=s(12047),$=s(85726);!function(e){e.DISABLED="disabled",e.IDLE="idle",e.PAINTING="painting"}(h||(h={}));class K extends g.Object3D{constructor(){super(),this._radius=.1,this._thickness=.005,this.name="SphereBrushCursor";const e=new g.MeshBasicMaterial({color:16777215,side:g.DoubleSide,depthTest:!1,transparent:!0}),t=this.getGeometry();this.mesh=new g.Mesh(t,e),this.mesh.renderOrder=V.z.reticule,this.add(this.mesh)}getGeometry(){return new g.RingGeometry(this._radius,this._radius+this._thickness,64)}updateCursorMesh(){this.mesh.geometry.dispose(),this.mesh.geometry=this.getGeometry()}get radius(){return this._radius}set radius(e){this._radius=e,this.updateCursorMesh()}dispose(){this.mesh.material.dispose(),this.mesh.geometry.dispose()}}const J=new Q.Z("pano-brush");class X{constructor(e,t,s,i,n=z.o.ALL){this.sweepData=e,this.cameraData=t,this.scene=s,this.input=i,this.cameraVector=new g.Vector3,this.lastPaint=new g.Vector3,this.mouseCursorEnabled=!1,this.needsUpdate=!0,this.observables={size:new $.f(.1),scale:new $.f(.2),feather:new $.f(.1),pressure:new $.f(.1),opacity:new $.f(1),state:new $.f(h.DISABLED)},this.position=new g.Vector3,this.direction=new g.Vector3,this.sizeRange=[.1,.5],this.featherRange=[.005,.125],this.pressureRange=[.0063,.0125],this.onPointerButton=e=>e.down?this.startPainting():this.stopPainting(),this.onPointerMove=e=>{const t=(0,Y.st)(this.cameraData,e.position);if(this.setPosition(t),this.state===h.PAINTING&&this.onPaint){const e=(0,k.et)(this.observables.size.value,this.sizeRange[0],this.sizeRange[1],.005,.03);if(this.lastPaint.length()>0){const t=this.direction.clone().sub(this.lastPaint).setLength(e),s=this.lastPaint.clone();for(;s.angleTo(this.direction)>e;)s.add(t).normalize(),this.lastPaint.copy(s),this.onPaint(s,this.observables.size.value,this.observables.feather.value,this.observables.pressure.value)}else this.lastPaint.copy(this.direction),this.onPaint(this.direction,this.observables.size.value,this.observables.feather.value,this.observables.pressure.value)}},this.onClick=e=>{const t=(0,Y.st)(this.cameraData,e.position);this.setPosition(t),this.onPaint&&this.onPaint(this.direction,this.observables.size.value,this.observables.feather.value,this.observables.pressure.value)},this.onMouseMove=e=>{const{tagName:t}=e.target||{},s=this.mouseCursorEnabled||!t||"CANVAS"!==t?null:D.C.NONE;s!==this.mouseCursor&&(this.engine.commandBinder.issueCommand(new I.u(s)),this.mouseCursor=s)},this.brushCursor=new K,this.brushCursor.renderOrder=V.z.reticule,this.brushCursor.layers.mask=n.mask}init(){this.bindings=new q.V(this.input.registerPriorityHandler(W._t,g.Mesh,(()=>!0)),this.input.registerHandler(B.mE,this.onPointerMove),this.input.registerHandler(B.er,this.onPointerButton),this.input.registerUnfilteredHandler(S.Rd,this.onClick),new Z.r(document.body,"mousemove",this.onMouseMove)),this.bindings.cancel()}render(){this.state!==h.DISABLED&&this.needsUpdate&&(this.brushCursor.position.copy(this.position),this.brushCursor.lookAt(this.scene.camera.getWorldPosition(this.cameraVector)),this.needsUpdate=!1)}dispose(){this.brushCursor.dispose()}activate(e){this.engine=e}deactivate(e){this.disable()}enable(){J.debug("Enabled"),this.observables.state.value=h.IDLE,this.bindings.renew(),this.scene.add(this.brushCursor)}disable(){J.debug("Disabled"),this.observables.state.value=h.DISABLED,this.bindings.cancel(),this.scene.remove(this.brushCursor),this.engine.commandBinder.issueCommand(new I.u(null))}onPropertyChanged(e,t){return this.observables[e].onChanged(t)}getSizeRange(){return this.sizeRange}setSizeRange(e,t){this.sizeRange=[e,t],this.scale=this.observables.scale.value}get scale(){return this.observables.scale.value}set scale(e){const t=(0,H.uZ)(e,0,1),s=(0,k.dS)(t,0,1,this.sizeRange[0],this.sizeRange[1]),i=(0,k.dS)(t,0,1,this.featherRange[0],this.featherRange[1]),n=(0,k.dS)(t,0,1,this.pressureRange[0],this.pressureRange[1]);this.brushCursor.radius=s,this.observables.size.value=s,this.observables.scale.value=t,this.observables.feather.value=i,this.observables.pressure.value=n,J.debug(`Set brush scale to ${100*t}% (${s})`)}get state(){return this.observables.state.value}get size(){return this.observables.size.value}set size(e){const t=(0,H.uZ)(e,this.sizeRange[0],this.sizeRange[1]),s=(0,k.dS)(t,this.sizeRange[0],this.sizeRange[1],0,1),i=(0,k.dS)(t,this.sizeRange[0],this.sizeRange[1],this.featherRange[0],this.featherRange[1]),n=(0,k.dS)(t,this.sizeRange[0],this.sizeRange[1],this.pressureRange[0],this.pressureRange[1]);this.brushCursor.radius=t,this.observables.size.value=t,this.observables.scale.value=s,this.observables.feather.value=i,this.observables.pressure.value=n,J.debug(`Set brush size to ${t} (${100*s}%)`)}toggleMouseCursor(e){this.mouseCursorEnabled=e}startPainting(){this.observables.state.value=h.PAINTING}stopPainting(){this.observables.state.value=h.IDLE,this.lastPaint.set(0,0,0)}setPosition(e){const t=this.sweepData.currentSweepObject;if(!t)return;const s=e.clone().sub(t.position).normalize(),i=t.position.clone().add(s);this.position.copy(i),this.direction.copy(s),this.needsUpdate=!0}}class ee extends g.InstancedMesh{}var te=s(69484),se=s(78692),ie=s(9832),ne=s(68540);const ae={brush:{uniforms:{opacity:{type:"v3",value:new g.Vector3(1,1,1)},color:{type:"c",value:new g.Color},radius:{type:"v3",value:new g.Vector3(.1,.1,.1)},feather:{type:"v3",value:new g.Vector3(0,0,0)}},vertexShader:s(59285),fragmentShader:s(65794)},combineBlurs:{uniforms:{maskMatrix:{type:"m4",value:new g.Matrix4},maskTexture:{type:"t",value:null},panoMatrix1:{type:"m4",value:new g.Matrix4},panoMatrix2:{type:"m4",value:new g.Matrix4},panoBlurredMap0:{type:"t",value:null},panoBlurredMap1:{type:"t",value:null},panoBlurredMap2:{type:"t",value:null},panoBlurredMap3:{type:"t",value:null}},vertexShader:s(77288),fragmentShader:s(34468)}};var re=s(3725);const oe=new g.Matrix4;function le(e){const t=new g.WebGLCubeRenderTarget(e,{format:g.RGBAFormat,generateMipmaps:!1,depthBuffer:!1,stencilBuffer:!1});return t.texture.image={},t.texture.image.width=e,t.texture.image.height=e,t}class ue{constructor(e,t,s){this.inputSize=e,this.outputSize=t,this.sigma=s,this.input=le(e),this.output=le(t)}get texture(){return this.output.texture}}class de{constructor(e,t){this.renderToTexture=e,this.renderer=t,this.renderTarget=new g.WebGLCubeRenderTarget(2048,{format:g.RGBAFormat,generateMipmaps:!1,depthBuffer:!1,stencilBuffer:!1}),this.camera=new g.PerspectiveCamera,this.blurRTs=re.TW.map((e=>((e,t,s)=>{const i=new ue(e,t,s);return{renderTarget:i,cubeCamera:new g.CubeCamera(.1,1e3,i.output)}})(e.size,2*e.size,e.sigma))),this.debug={};const s=g.UniformsUtils.clone(ae.combineBlurs.uniforms);this.material=new g.RawShaderMaterial({fragmentShader:ae.combineBlurs.fragmentShader,vertexShader:ae.combineBlurs.vertexShader,uniforms:s,side:g.DoubleSide,name:"CubemapRendererMaterial"}),this.mesh=new g.Mesh(new g.BoxGeometry(100,100,100),this.material),this.material.uniforms.panoBlurredMap0.value=this.blurRTs[0].renderTarget.texture,this.material.uniforms.panoBlurredMap1.value=this.blurRTs[1].renderTarget.texture,this.material.uniforms.panoBlurredMap2.value=this.blurRTs[2].renderTarget.texture,this.material.uniforms.panoBlurredMap3.value=this.blurRTs[3].renderTarget.texture,this.renderTarget.texture.image={},this.renderTarget.texture.image.height=2048,this.renderTarget.texture.image.width=2048}setDebug(e,t){t?this.debug[e]=!0:this.debug[e]&&delete this.debug[e],this.material.defines=this.debug,this.material.needsUpdate=!0,this.render()}render(){this.renderToTexture.render(this.renderTarget,this.mesh,this.camera)}get texture(){return this.renderTarget.texture}setMaskTexture(e,t=oe){this.material.uniforms.maskTexture.value=e,this.material.uniforms.maskMatrix.value.copy(t)}setPano(e,t,s=oe,i=oe){if(e!==this.currentSweepId||this.currentPanoTexture!==t){this.currentSweepId=e,this.currentPanoTexture=t;for(const e of this.blurRTs){const s=e.renderTarget,i=.5/s.input.width;this.renderer.copyCubemap(t,s.input),this.renderer.blurCubemap(s.input.texture,e.cubeCamera,s.sigma,i)}this.material.uniforms.panoMatrix1.value.copy(s),this.material.uniforms.panoMatrix2.value.copy(i)}}reset(){this.currentSweepId=null,this.currentPanoTexture=null}}class ce extends g.RawShaderMaterial{constructor(e,t,s,i){const n=g.UniformsUtils.clone(ae.brush.uniforms);n.radius.value.copy(e),n.feather.value.copy(t),n.opacity.value.copy(s),n.color.value.set(1,0,0),super(Object.assign(Object.assign({},i),{fragmentShader:ae.brush.fragmentShader,vertexShader:ae.brush.vertexShader,uniforms:n,side:g.FrontSide,transparent:!0,blending:g.AdditiveBlending,name:"brushMaterial"}))}get color(){return this.uniforms.color.value}set color(e){this.uniforms.color.value=e}}var he=s(25565),ge=s(35557);const me=new g.Color(16711680),pe=new g.Color(65280),be=new g.Color(255);class fe{constructor(e,t,s,i,n,a,r){this.sweepData=e,this.blurEditorData=t,this.scene=s,this.input=i,this.panoRenderer=r,this.root=new g.Group,this.meshes={},this.maskRenderTarget=new g.WebGLCubeRenderTarget(1024,{format:g.RGBAFormat,generateMipmaps:!1}),this.maskCamera=new g.PerspectiveCamera,this.maskBackground=new g.Mesh(new g.BoxGeometry(10,10,10),new g.MeshBasicMaterial({color:0,side:g.DoubleSide})),this.maskVisible=!1,this.dirty=!0,this.updating=!1,this.bindings=[],this.blurs=[],this.renderBlurredOverlay=(()=>{const e=new g.Matrix4,t=new g.Matrix4,s=new g.Quaternion;return async i=>{this.maskCamera.position.copy(i.position),this.maskBackground.position.copy(i.position),await this.engine.commandBinder.issueCommand(new ie.sp(this.maskRenderTarget,this.root,this.maskCamera));const n=this.maskRenderTarget.texture,a=this.panoRenderer.useTexture(i.id);e.makeRotationFromQuaternion(s.copy(i.rotation).invert()),t.makeScale(-1,1,1),this.overlayRenderer.setPano(i.id,a,e,t),this.overlayRenderer.setMaskTexture(n),this.overlayRenderer.render(),this.panoRenderer.freeTexture(i.id),await this.engine.after(te.A.Begin),await this.engine.commandBinder.issueCommand(new se.M(i.id,this.overlayRenderer.texture,new g.Quaternion))}})(),this.currentSweep=this.sweepData.currentSweepObject||null,this.overlayRenderer=new de(n,a)}setBlurs(e){this.blurs!==e&&(this.blurs=e,this.dirty=!0)}init(){this.root.add(this.maskBackground)}async activate(e){const[t]=await Promise.all([e.getModuleBySymbol(b.Ak)]);this.engine=e,this.meshes={},this.bindings.push(this.blurEditorData.onChanged((()=>this.dirty=!0)),e.subscribe(ne.Z,(e=>{this.currentSweep=this.sweepData.getSweep(e.toSweep),this.dirty=!0})),e.subscribe(ge.Xq,(()=>{this.overlayRenderer.reset(),this.currentSweep&&this.renderBlurredOverlay(this.currentSweep)}))),t.registerButton("Blur Debug","Toggle blur level coloration",(()=>{this.overlayRenderer.setDebug("DEBUG_BLUR_COLORS",!this.overlayRenderer.debug.DEBUG_BLUR_COLORS),this.currentSweep&&this.renderBlurredOverlay(this.currentSweep)})),t.registerButton("Blur Debug","Toggle blur test",(()=>{this.overlayRenderer.setDebug("DEBUG_BLUR_LEVELS",!this.overlayRenderer.debug.DEBUG_BLUR_LEVELS),this.currentSweep&&this.renderBlurredOverlay(this.currentSweep)})),this.maskRenderTarget.texture.image={},this.maskRenderTarget.texture.image.width=1024,this.maskRenderTarget.texture.image.height=1024}dispose(){this.root.traverse((e=>{e instanceof g.Mesh&&e.geometry.dispose()}))}render(){this.dirty&&!this.updating&&(this.updating=!0,this.dirty=!1,this.update().finally((()=>{this.updating=!1})))}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0}getBlursForSweep(e){return this.blurs.filter((t=>t.sweepId===e))}async update(){var e,t;if(!this.currentSweep)return;const s=this.currentSweep,n=this.getBlursForSweep(s.id),a={};for(const e of n)for(const[t,s]of e.dots.entries())a[`${e.id}-${t}`]=s;let r=!1;for(const e in this.meshes){const t=this.meshes[e];a[e]&&a[e].directions.length===t.count||(this.root.remove(t),this.input.unregisterMesh(t),delete this.meshes[e],r=!0)}const o=new g.Vector3,l=new g.Vector3,u=new g.Vector3,d=new g.Matrix4,c=new g.Vector3;for(const e of n)for(const[t,i]of e.dots.entries()){const n=`${e.id}-${t}`;if(0===i.directions.length||this.meshes[n])continue;o.set(i.radius,i.radius-i.feather,i.radius),l.set(i.feather,i.feather,i.feather),u.set(i.strength,1,i.strength);const a=new ce(o,l,u,{defines:{USE_INSTANCING:!0},depthTest:!1,depthWrite:!1}),h=new ee((0,he.fc)(),a,i.directions.length);h.blurId=e.id,i.directions.forEach(((e,t)=>{const n=2*(i.radius+i.feather),a=ve(e,s);d.lookAt(s.position,a,P.fU.UP),d.scale(c.set(n,n,n)),d.setPosition(a),h.setMatrixAt(t,d)})),h.computeBoundingSphere(),this.meshes[n]=h,this.root.add(h),this.input.registerMesh(h,!1),r=!0}const h=new g.Color,{toolState:m,selectedBlur:p,hoveredBlur:b}=this.blurEditorData;for(const s in this.meshes){const n=this.meshes[s],a=n.material;h.copy(me);let o=V.z.reticule+.1;const l=null===(e=null==b?void 0:b.editable)||void 0===e||e,u=null===(t=null==p?void 0:p.editable)||void 0===t||t;m!==i.PAINTING&&(l&&n.blurId===(null==b?void 0:b.id)&&(h.add(be),o=V.z.reticule+.2),u&&n.blurId===(null==p?void 0:p.id)&&(h.add(pe),o=V.z.reticule+.3)),a.color.equals(h)&&n.renderOrder===o||(a.color.copy(h),n.renderOrder=o,r=!0)}r&&await this.renderBlurredOverlay(s)}setMaskVisibility(e){this.maskVisible!==e&&(e?this.scene.add(this.root):this.scene.remove(this.root),this.maskVisible=e)}}function ve(e,t){const s=e.clone().applyQuaternion(t.rotation).normalize();return t.position.clone().add(s)}var Se=s(42141),Be=s(64831),Ee=s(42896);class Ce extends Be.T{constructor(){super(...arguments),this.selected=!1,this.hovered=!1}}class we extends Be.T{constructor(){super(...arguments),this.openedTool=!1,this.createdBlur=!1}}class ye extends Se.V{constructor(){super(...arguments),this.name="blur-editor",this.toolState=i.IDLE,this.brushCursorVisibility=!1,this.interactions=new we,this.showMouseCursor=!1,this.states=new Ee.v,this._selectedBlur=null,this._hoveredBlur=null}getState(e){let t=this.states.get(e);return t||(t=new Ce,this.states.set(e,t)),t}get selectedBlur(){return this._selectedBlur}set selectedBlur(e){if(this.selectedBlur===e)return;const t=this.selectedBlur;if(this._selectedBlur=e,this.commit(),e){const t=this.getState(e.id);t.selected=!0,t.commit()}if(t){const e=this.getState(t.id);e.selected=!1,e.commit()}}onSelectedBlurChanged(e){return this.onPropertyChanged("_selectedBlur",e)}get hoveredBlur(){return this._hoveredBlur}set hoveredBlur(e){if(this.hoveredBlur===e)return;const t=this.hoveredBlur;if(this._hoveredBlur=e,this.commit(),e){const t=this.getState(e.id);t.hovered=!0,t.commit()}if(t){const e=this.getState(t.id);e.hovered=!1,e.commit()}}onHoveredBlurChanged(e){return this.onPropertyChanged("_hoveredBlur",e)}}var Te=s(69947),xe=s(20360),Ie=s(3451),De=s(46301),Ae=s(82196),_e=s(7321),Re=s(30922),Oe=s(40475),Le=s(38496),Pe=s(16928),ke=s(79884),Ne=s(97187),Me=s(6394),Ue=s(49982),Ge=s(63308),je=s(13268),Fe=s(95873),ze=s(85893),Ve=s(78897),He=s(80308);const{BLURS:Qe,SCANS:We,MODAL:Ye}=_e.Z.WORKSHOP;function qe({sweepCount:e,blurCount:t,failedBlurCount:s,nudge:i}){const n=(0,Ve.b)(),a=n.t(We.NUM_TYPE,e),r=n.t(Qe.NUM_TYPE,t),o=n.t(Qe.APPLY_MODAL_MESSAGE,{scans:a,blurs:r}),l=n.t(Qe.APPLY_MODAL_WARNING),u=n.t(Qe.APPLY_MODAL_NUDGE_MESSAGE);let d;s>0&&(d=n.t(Qe.APPLY_MODAL_RETRY));const c=t>re.Dr&&n.t(Qe.APPLY_MODAL_TRUNCATED,{blurs:r,maxBlurs:re.Dr});return(0,ze.jsxs)("div",{children:[i&&(0,ze.jsx)("p",{children:u}),(0,ze.jsx)("p",{dangerouslySetInnerHTML:{__html:o}}),(0,ze.jsx)("p",{dangerouslySetInnerHTML:{__html:l}}),d&&(0,ze.jsx)("p",{dangerouslySetInnerHTML:{__html:d}}),c&&(0,ze.jsx)("p",{dangerouslySetInnerHTML:{__html:c}})]})}const Ze=async(e,t,s)=>{if(!e.hasUnappliedBlurs())return!1;const i=e.getByStatus(T.Q.PENDING,T.Q.FAILED),n=e.getByStatus(T.Q.FAILED),a=new Set(i.map((e=>e.sweepId))),r=s?Qe.APPLY_MODAL_NUDGE_TITLE:Qe.APPLY_MODAL_TITLE,o=s?Qe.APPLY_MODAL_NUDGE_CANCEL:Ye.NO,l={title:r,message:(0,ze.jsx)(qe,{sweepCount:a.size,blurCount:i.length,failedBlurCount:n.length,nudge:s}),cancellable:!0,confirmPhraseKey:Qe.APPLY_MODAL_CONFIRM,cancelPhraseKey:o,cancelVariant:s?He.Wu.TERTIARY:He.Wu.SECONDARY,modalClass:"blur-tool-modal full-modal"};return await t.issueCommand(new Ue.EW(Ue.Rx.DISPLAY,l))===Ue.Uc.CONFIRM},{SUGGESTIONS:$e}=_e.Z.WORKSHOP;class Ke{constructor(e,t){this.engine=e,this.settingsData=t,this.initialized=!1,this.toggledAssets={[Pe.U]:!1,[Re.re]:!1,[Oe.Mp]:!1,[Ae.Nj]:!1,[Le.s]:!1},this.navigateToNextSuggestion=(e,t)=>{let s;for(let i=0;i<e.length;i++){const n=e[i],a=n.items.indexOf(t);if(-1!==a){const t=a+1;t<n.items.length?s=n.items[t]:e[i+1]&&e[i+1].items.length&&(s=e[i+1].items[0]);break}}s&&this.engine.commandBinder.issueCommand(new o(s,!1))},this.debouncedNavigateToNextSuggestion=(0,Me.D)(this.navigateToNextSuggestion,500),this.settingsToggler=new De.u(this.settingsData,this.toggledAssets)}async activate(){var e;if(!this.initialized){this.initialized=!0;const{market:e}=this.engine;[this.blurData,this.sweepViewData,this.viewmodeData,this.suggestionData]=await Promise.all([e.waitForData(y.f),e.waitForData(ke.D),e.waitForData(_.O),e.waitForData(Ge.a)])}const t=null===(e=this.sweepViewData.data.currentSweepObject)||void 0===e?void 0:e.isAligned(),s=this.viewmodeData.canStartTransition()&&this.viewmodeData.currentMode!==R.Ey.Panorama;s&&!t&&await this.engine.commandBinder.issueCommand(new Ne._i(Ne.BD.INSIDE)),this.settingsToggler.toggle(!0),this.toggleBlurTool(i.IDLE),s&&t&&await this.engine.commandBinder.issueCommand(new Ne._i(Ne.BD.INSIDE))}async deactivate(){if(this.blurData&&!this.blurData.hasProcessingBlurs()&&this.blurData.hasUnappliedBlurs()){await Ze(this.blurData,this.engine.commandBinder,!0)&&this.engine.commandBinder.issueCommand(new C.Mh)}this.settingsToggler.toggle(!1),await this.toggleBlurTool(i.OFF)}async toggleBlurTool(e){await this.engine.commandBinder.issueCommand(new a(e))}async rejectAllSuggestions(){if(!this.suggestionData)return!1;const e=this.suggestionData.getByAccepted(null).map((e=>e.id));if(!e.length)return!1;const t=(0,Fe.P)(e.length,$e.TYPE);return await this.engine.commandBinder.issueCommand(new Ue.EW(Ue.Rx.DISPLAY,t))!==Ue.Uc.CLOSE&&(this.engine.commandBinder.issueCommand(new je.oA(...e)),!0)}}var Je=s(67294),Xe=s(94184),et=s.n(Xe),tt=s(29707),st=s(79284),it=s(61173),nt=s(72676),at=s(66379),rt=s(69757),ot=s(72439);const lt="Blur-Help",{BLURS:ut}=_e.Z.WORKSHOP;function dt({canAdd:e,selectedBlur:t,onClickAdd:s,onDelete:n,toolState:a,nudgeDisabled:r}){const o=(0,Ve.b)(),l=o.t(ut.CREATE_TOOLTIP_TITLE),u=o.t(ut.CREATE_TOOLTIP_MESSAGE);let d=ot.d.ADD;a===i.PAINTING&&(d=t?ot.d.CONFIRM:ot.d.CANCEL);const c=e&&t&&t.editable?(0,ze.jsx)(He.zx,{className:"action-button-outer",variant:He.Wu.FAB,theme:"overlay",icon:"delete",onClick:n}):void 0;return(0,ze.jsx)(rt.o,Object.assign({outerRight:c},{children:(0,ze.jsx)(ot.H,{addIcon:d,onClick:s,disabled:!e,ariaDescribedBy:lt,nudgeMessage:u,nudgeTitle:l,nudgeLocalStorage:at.F.BlursAddNudgeSeen})}))}var ct,ht=s(53349),gt=s(77963);!function(e){e.size="size",e.scale="scale",e.feather="feather",e.pressure="pressure",e.opacity="opacity",e.state="state"}(ct||(ct={}));var mt=s(38908);const pt=(0,mt.u)(ye);function bt(){const e=pt();return(null==e?void 0:e.brush)||null}var ft=s(39469);const{BLURS:vt}=_e.Z.WORKSHOP,St="blur-nudge-seen";function Bt({toolState:e}){const t=(0,Ve.b)(),[s,n]=(0,Je.useState)(20),a=(0,gt.y)(St,!1),[o,l]=(0,Je.useState)(!a),{commandBinder:u,settings:d}=(0,Je.useContext)(tt.I),[c,h]=(0,Je.useState)(null),g=function(){const e=bt(),[t,s]=(0,Je.useState)(.2);return(0,Je.useEffect)((()=>{if(!e)return()=>{};const t=()=>{s(e.scale)},i=e.onPropertyChanged(ct.scale,t);return t(),()=>i.cancel()}),[e]),t}();if((0,Je.useEffect)((()=>{const e=Math.round((0,k.et)(g,0,1,1,100));n(e)}),[g]),(0,Je.useEffect)((()=>()=>{d.setProperty(St,!0)}),[]),e!==i.PAINTING)return null;const m=t.t(vt.BRUSH_TOOLTIP_TITLE),p=t.t(vt.BRUSH_TOOLTIP_MESSAGE),b=(0,ze.jsx)(ft.p,{className:"nudge-featured",title:m,message:p,closeButton:!0}),f={trigger:"static",onToggle:e=>{e||l(!1)},theme:"light",size:"small",className:"nudge-button-tooltip",placement:"top",offset:[0,30]};return(0,ze.jsxs)("div",Object.assign({className:"brush-controls"},{children:[(0,ze.jsx)("div",Object.assign({className:"brush-size-control",ref:h},{children:(0,ze.jsx)(ht.Z,{min:1,max:100,step:1,included:!0,dots:!1,value:s,onChange:e=>{l(!1);const t=(0,k.et)(e,1,100,0,1);u.issueCommand(new r(t))}})})),o&&(0,ze.jsx)(He.u,Object.assign({title:b,target:c},f))]}))}function Et(){var e;const t=bt(),[s,i]=(0,Je.useState)(null!==(e=null==t?void 0:t.state)&&void 0!==e?e:h.DISABLED);return(0,Je.useEffect)((()=>{if(!t)return()=>{};const e=()=>{i(t.state)},s=t.onPropertyChanged(ct.state,e);return e(),()=>s.cancel()}),[t]),s}var Ct=s(6373);const wt=(0,mt.u)(y.f);function yt(){const e=wt(),[t,s]=(0,Je.useState)(new Ct.Q(new Ee.v));return(0,Je.useEffect)((()=>{e&&s(new Ct.Q(e.blurs))}),[e]),(0,Je.useEffect)((()=>{t.priority=Ct.K.LOW,t.sort(((e,t)=>t.index-e.index))}),[t]),t}function Tt(){const e=pt(),[t,s]=(0,Je.useState)(i.OFF);return(0,Je.useEffect)((()=>{const t=[];if(e){const i=()=>{s(e.toolState)};t.push(e.onPropertyChanged("toolState",i)),i()}return()=>{t.forEach((e=>e.cancel()))}}),[e]),t}function xt(){const[e,t]=(0,Je.useState)(null),s=pt();return(0,Je.useEffect)((()=>{const e=[];return s&&(e.push(s.onSelectedBlurChanged((e=>t(e)))),t(s.selectedBlur)),()=>{e.forEach((e=>e.cancel()))}}),[s]),e}var It=s(49095),Dt=s(15187);function At(){const e=(0,Dt.K)();return!!e&&(0,It.eU)(e)}const{BLURS:_t}=_e.Z.WORKSHOP;function Rt(){const{commandBinder:e,locale:t}=(0,Je.useContext)(tt.I),s=Et(),n=function(){const e=Et(),t=pt(),s=!!(null==t?void 0:t.interactions.createdBlur),i=e===h.PAINTING,[n,a]=(0,Je.useState)(!s&&!i);return(0,Je.useEffect)((()=>{let e;return t&&(e=t.interactions.onPropertyChanged("createdBlur",(()=>{a(!1)}))),n&&i&&a(!1),()=>null==e?void 0:e.cancel()}),[t,i,n]),n}(),r=yt(),o=Tt(),l=xt(),u=(0,nt.B)(),d=!At(),c=(0,Je.useCallback)((()=>{let t=i.IDLE;o===i.IDLE&&(t=i.PAINTING),e.issueCommand(new a(t))}),[e,o]),g=(0,Je.useCallback)((async()=>{if(!l)throw new Error("Cannot delete, no Blur selected");await e.issueCommand(new C.TL(l.id)),o===i.PAINTING&&await e.issueCommand(new a(i.IDLE))}),[e,l,o]),m=et()("blur-tool-overlay","overlay","grid-overlay",{painting:s===h.PAINTING}),p=o===i.SUGGESTING,b=l&&t.t(p?_t.SUGGESTED_BLUR:_t.DEFAULT_BLUR_NAME,{number:l.index}),f=!d||!r||r.length>0,v=t.t((0,it.Jm)()?_t.OVERLAY_MESSAGE_TOUCH:_t.OVERLAY_MESSAGE);return(0,ze.jsxs)("div",Object.assign({className:m},{children:[l&&(0,ze.jsx)(st.u,{children:b}),!p&&(0,ze.jsxs)(ze.Fragment,{children:[d&&n&&(0,ze.jsxs)("div",Object.assign({className:"overlay-message"},{children:[(0,ze.jsx)("div",{className:"icon icon-brush-outline"}),(0,ze.jsx)("span",Object.assign({id:lt,className:"message"},{children:v}))]})),(0,ze.jsx)(dt,{toolState:o,nudgeDisabled:f,canAdd:d&&u===R.Ey.Panorama,selectedBlur:l,onClickAdd:c,onDelete:g}),(0,ze.jsx)(Bt,{toolState:o})]})]}))}var Ot,Lt=s(25537),Pt=s(81746);!function(e){e.SCANS="scans",e.FLOORS="floors"}(Ot||(Ot={}));const{BLURS:kt}=_e.Z.WORKSHOP,Nt={all:kt.BLUR_STATUS_ALL,[T.Q.PENDING]:kt.BLUR_STATUS_PENDING,[T.Q.APPLIED]:kt.BLUR_STATUS_APPLIED,[T.Q.FAILED]:kt.BLUR_STATUS_FAILED,[T.Q.PROCESSING]:kt.BLUR_STATUS_PROCESSING},Mt=({value:e,onChange:t})=>{const s=(0,Ve.b)(),i=s.t(e?Nt[e]:kt.STATUS);return(0,ze.jsxs)(He.xz,Object.assign({className:"blur-filter blur-filter-status",variant:He.Wu.TERTIARY,label:i,ariaLabel:i,caret:!0},{children:[(0,ze.jsx)(He.zx,{label:s.t(kt.BLUR_STATUS_ALL),size:He.qE.SMALL,variant:He.Wu.TERTIARY,onClick:()=>t("all")}),(0,ze.jsx)(He.zx,{label:s.t(kt.BLUR_STATUS_PENDING),size:He.qE.SMALL,variant:He.Wu.TERTIARY,onClick:()=>t(T.Q.PENDING)}),(0,ze.jsx)(He.zx,{label:s.t(kt.BLUR_STATUS_APPLIED),size:He.qE.SMALL,variant:He.Wu.TERTIARY,onClick:()=>t(T.Q.APPLIED)}),(0,ze.jsx)(He.zx,{label:s.t(kt.BLUR_STATUS_FAILED),size:He.qE.SMALL,variant:He.Wu.TERTIARY,onClick:()=>t(T.Q.FAILED)})]}))},Ut={[Ot.SCANS]:kt.GROUP_BY_SCAN,[Ot.FLOORS]:kt.GROUP_BY_FLOOR},Gt=({value:e,onChange:t})=>{const s=(0,Ve.b)(),i=s.t(e?Ut[e]:kt.GROUP_BY);return(0,ze.jsxs)(He.xz,Object.assign({className:"blur-filter blur-filter-groupby",variant:He.Wu.TERTIARY,label:i,ariaLabel:i,caret:!0},{children:[(0,ze.jsx)(He.zx,{label:s.t(kt.GROUP_BY_SCAN),size:He.qE.SMALL,variant:He.Wu.TERTIARY,onClick:()=>t(Ot.SCANS)}),(0,ze.jsx)(He.zx,{label:s.t(kt.GROUP_BY_FLOOR),size:He.qE.SMALL,variant:He.Wu.TERTIARY,onClick:()=>t(Ot.FLOORS)})]}))},jt={CREATED_DESC:kt.SORT_CREATED_DESC,CREATED_ASC:kt.SORT_CREATED_ASC},Ft=({value:e,onChange:t})=>{const s=(0,Ve.b)(),i=s.t(e?jt[e]:kt.SORT);return(0,ze.jsxs)(He.xz,Object.assign({className:"blur-filter blur-filter-sort",variant:He.Wu.TERTIARY,label:i,ariaLabel:i,caret:!0},{children:[(0,ze.jsx)(He.zx,{label:s.t(kt.SORT_CREATED_DESC),size:He.qE.SMALL,variant:He.Wu.TERTIARY,onClick:()=>t("CREATED_DESC")}),(0,ze.jsx)(He.zx,{label:s.t(kt.SORT_CREATED_ASC),size:He.qE.SMALL,variant:He.Wu.TERTIARY,onClick:()=>t("CREATED_ASC")})]}))};var zt=s(41865),Vt=s(85938);function Ht(){const[e,t]=(0,Je.useState)(null),s=pt();return(0,Je.useEffect)((()=>{const e=[];return s&&(e.push(s.onHoveredBlurChanged((e=>t(e)))),t(s.hoveredBlur)),()=>{e.forEach((e=>e.cancel()))}}),[s]),e}const{BLURS:Qt}=_e.Z.WORKSHOP;function Wt({blur:e}){const{commandBinder:t}=(0,Je.useContext)(tt.I),s=pt(),i=xt(),n=Ht(),a=(0,Ve.b)(),r=(0,zt.z)(),l=(0,Je.useCallback)((()=>{t.issueCommand(new o(e,!0))}),[t,e]),c=(0,Je.useCallback)((()=>{const s=e.visible;s?t.issueCommand(new d(e.id)):t.issueCommand(new u(e.id)),r.trackToolGuiEvent("blur","blur_list_click_"+(s?"hide":"show"))}),[t,e,r]),h=(0,Je.useCallback)((()=>{t.issueCommand(new C.TL(e.id)),r.trackToolGuiEvent("blur","blur_list_click_delete")}),[t,e,r]),g=(0,Je.useCallback)((()=>{s&&(s.hoveredBlur=e)}),[e,s]),m=(0,Je.useCallback)((()=>{s&&(s.hoveredBlur=null)}),[s]),p=e.status!==T.Q.PENDING,b=(0,ze.jsxs)("span",{children:[a.t(Qt.DEFAULT_BLUR_NAME,{number:e.index}),p&&(0,ze.jsx)("span",Object.assign({className:"blur-status"},{children:e.status}))]}),f=e.status!==T.Q.APPLIED&&e.status!==T.Q.PROCESSING,v=a.t(Qt.DELETE_BLUR_CTA),S=(0,ze.jsx)(He.hE,{children:f&&(0,ze.jsxs)(ze.Fragment,{children:[(0,ze.jsx)(Vt.Z,{id:e.id,visible:e.visible,showTooltip:Qt.SHOW_LIST_ITEM_TOOLTIP_MESSAGE,hideTooltip:Qt.HIDE_LIST_ITEM_TOOLTIP_MESSAGE,onClick:c}),(0,ze.jsx)(He.xz,Object.assign({icon:"more-vert",ariaLabel:a.t(_e.Z.MORE_OPTIONS),menuArrow:!0,menuClassName:"search-result-menu"},{children:(0,ze.jsx)(He.zx,{className:"menu-delete-btn",label:v,size:He.qE.SMALL,variant:He.Wu.TERTIARY,onClick:h})}))]})}),B=et()("blur-list-item",{active:i&&i.id===e.id},{hover:n&&n.id===e.id});return(0,ze.jsx)(He.HC,{className:B,onClick:l,onMouseEnter:g,onMouseLeave:m,actions:S,title:b,id:e.id})}var Yt=s(57771),qt=s(75921);const Zt="other",{BLURS:$t,SCANS:Kt,VIEWS_360:Jt}=_e.Z.WORKSHOP;function Xt(e){const[t,s]=(0,Je.useState)(Ot.SCANS),[i,n]=(0,Je.useState)([]),a=(0,Ve.b)(),r=(0,Yt.F)(),o=(0,qt.I)(),l=(0,Je.useCallback)((()=>{const t={};if(e&&r){const s=r.getAlignedSweeps(!1),i=e.groupBy("sweepId");for(const e in i){const n=r.getSweep(e);let o=a.t(Kt.LIST_ITEM_TEXT,n.index+1);if(!n.isAligned()){const e=s.findIndex((e=>e.id===n.id))||0;o=n.name||a.t(Jt.DEFAULT_NAME,{index:e+1})}t[e]={id:`sweep-${n.id}`,data:n,title:o,items:i[e]}}}return t}),[e,a,r]),u=(0,Je.useCallback)((()=>{const t={};if(e&&o){const s=e.groupBy("floorId");o.floors.iterate((e=>{t[e.id]={id:e.id,data:e,title:e.name,items:s[e.id]||[]}})),s.null&&(t.other={id:Zt,title:a.t($t.OTHER_GROUP_LABEL),items:s.null})}return t}),[e,a,o]),d=(0,Je.useCallback)((()=>{const e=t===Ot.SCANS?l():u(),s=Object.values(e).sort(((e,t)=>e.title.localeCompare(t.title,void 0,{numeric:!0})));n(s)}),[l,u,t]);return(0,Je.useEffect)((()=>{const t=[e.onChanged((()=>{d()}))];return d(),()=>{t.forEach((e=>e.cancel()))}}),[e,t,a,d]),{groups:i,groupBy:t,setGroupBy:s}}const es=(0,mt.u)(Ge.a);const{BLURS:ts}=_e.Z.WORKSHOP;let ss=!1;const is=()=>{const e=function(){const e=es(),[t,s]=(0,Je.useState)(0);return(0,Je.useEffect)((()=>{if(!e)return()=>{};const t=()=>{s(e.getByAccepted(null).length)},i=e.onChanged(t);return t(),()=>i.cancel()}),[e]),t}(),{commandBinder:t}=(0,Je.useContext)(tt.I),s=(0,Ve.b)(),n=(0,zt.z)(),r=(0,Je.useCallback)((()=>{n.trackToolGuiEvent("blur","blur_click_view_suggestions"),t.issueCommand(new a(i.SUGGESTING))}),[t,n]);if(!e)return null;const o=s.t(ts.SUGGESTIONS_AVAILABLE_MESSAGE,e),l=(0,ze.jsxs)(He.zx,Object.assign({size:He.qE.SMALL,variant:He.Wu.SECONDARY,onClick:r},{children:[(0,ze.jsx)(He.o3,{}),(0,ze.jsx)("span",{children:s.t(ts.VIEW_SUGGESTIONS)})]}));return ss||(ss=!0,n.trackToolGuiEvent("blur","blur_suggestions_banner_shown")),(0,ze.jsx)(He.jL,{layout:"horizontal",text:o,actions:l,className:"blur-list-banner"})};var ns=s(79656);const{BLURS:as}=_e.Z.WORKSHOP,rs=({group:e})=>{const{id:t,items:s}=e;return(0,ze.jsx)(ns.J,{id:t,numItems:s.length})},os=({group:e})=>{const{id:t,title:s,items:i}=e;return(0,ze.jsx)(He._m,{id:t,title:s,decals:(0,ze.jsx)("span",Object.assign({className:"mp-list-item-text"},{children:`(${i.length})`}))})},ls=({item:e})=>{const t=(0,Ve.b)();if(!e){const e=t.t(as.MULTI_FLOOR_EMPTY_MESSAGE);return(0,ze.jsx)(He.gQ,{message:e})}return(0,ze.jsx)(Wt,{blur:e})},us=({className:e=""})=>{const t=yt(),s=(0,Ve.b)(),i=(0,zt.z)(),[n,a]=(0,Je.useState)(null),{groups:r,groupBy:o,setGroupBy:l}=Xt(t),u=(0,Je.useCallback)((e=>{(0,Pt.p)(T.Q,e)?t.setFilter("status",(t=>t.status===e)):t.clearFilter("status"),null!==e&&i.trackToolGuiEvent("blur",`blur_list_filter_by_${e}`),a(e)}),[t,i]),[d,c]=(0,Je.useState)(null),h=(0,Je.useCallback)((e=>{switch(e){case"CREATED_DESC":t.sort(((e,t)=>e.created.getTime()-t.created.getTime()||e.index-t.index));break;case"CREATED_ASC":t.sort(((e,t)=>t.created.getTime()-e.created.getTime()||t.index-e.index))}null!==e&&i.trackToolGuiEvent("blur",`blur_list_sort_by_${e.toLowerCase()}`),c(e)}),[t,i]),g=(0,Je.useCallback)((e=>{i.trackToolGuiEvent("blur",`blur_list_group_by_${e.toLowerCase()}`),l(e)}),[l,i]),m=et()(e,"blur-list"),p=s.t(as.NO_BLURS);return(0,ze.jsxs)("div",Object.assign({className:m},{children:[(0,ze.jsxs)("header",Object.assign({className:"blur-list-header"},{children:[(0,ze.jsx)(is,{}),(0,ze.jsxs)(He.w0,{children:[(0,ze.jsx)(Gt,{value:o,onChange:g}),(0,ze.jsx)(Mt,{value:n,onChange:u}),(0,ze.jsx)(Ft,{value:d,onChange:h})]})]})),(0,ze.jsx)("div",Object.assign({className:"blur-list-content"},{children:0===r.length?(0,ze.jsx)(He.gQ,{message:p,itemHeight:60}):(0,ze.jsx)(He.UQ,{ariaExpandLabel:s.t(_e.Z.ACCORDIONS.EXPAND),ariaCollapseLabel:s.t(_e.Z.ACCORDIONS.COLLAPSE),data:r,itemHeight:60,renderItem:ls,renderGroup:o===Ot.FLOORS?rs:os})}))]}))};function ds(){const e=es(),[t,s]=(0,Je.useState)(new Ct.Q(new Ee.v));return(0,Je.useEffect)((()=>{e&&s(new Ct.Q(e.suggestions))}),[e]),(0,Je.useEffect)((()=>{t.priority=Ct.K.LOW,t.sort(((e,t)=>t.index-e.index)),t.setFilter("accepted",(e=>null===e.accepted))}),[t]),t}const{BLURS:cs}=_e.Z.WORKSHOP,hs=({suggestion:e,onResolved:t})=>{const{commandBinder:s}=(0,Je.useContext)(tt.I),i=(0,zt.z)(),n=(0,Ve.b)(),a=pt(),r=Ht(),l=xt(),[u,d]=(0,Je.useState)(null),c=(0,Je.useCallback)((()=>{s.issueCommand(new je.rf(e.id)),i.trackToolGuiEvent("blur","blur_suggestion_list_click_accept"),t(e,!0)}),[i,s,e,t]),h=(0,Je.useCallback)((()=>{s.issueCommand(new je.oA(e.id)),i.trackToolGuiEvent("blur","blur_suggestion_list_click_reject"),t(e,!1)}),[i,s,e,t]),g=(0,Je.useCallback)((e=>{u||(d("accepted"),setTimeout(c,500),e.stopPropagation())}),[c,u]),m=(0,Je.useCallback)((e=>{u||(d("rejected"),setTimeout(h,500),e.stopPropagation())}),[h,u]),p=(0,Je.useCallback)((t=>{const n=e.visible;n?s.issueCommand(new je.mA(e.id)):s.issueCommand(new je.ee(e.id)),i.trackToolGuiEvent("blur","blur_suggestion_list_click_"+(n?"hide":"show")),t.stopPropagation()}),[i,s,e]),b={placement:"top"},f=(0,Je.useCallback)((()=>{a&&(a.hoveredBlur=e)}),[e,a]),v=(0,Je.useCallback)((()=>{a&&(a.hoveredBlur=null)}),[a]),S=(0,ze.jsxs)(He.hE,{children:[(0,ze.jsx)(He.zx,{icon:e.visible?"eye-show":"eye-hide",onClick:p,tooltip:e.visible?n.t(cs.HIDE_LIST_ITEM_TOOLTIP_MESSAGE):n.t(cs.SHOW_LIST_ITEM_TOOLTIP_MESSAGE),tooltipOptions:b}),(0,ze.jsx)(He.zx,{icon:"checkmark",onClick:g,tooltip:n.t(cs.ACCEPT_SUGGESTION_TOOLTIP),tooltipOptions:b}),(0,ze.jsx)(He.zx,{icon:"close",onClick:m,tooltip:n.t(cs.REJECT_SUGGESTION_TOOLTIP),tooltipOptions:b})]}),B=n.t(cs.SUGGESTED_BLUR,{number:e.index}),E=et()("blur-suggestion-list-item",{active:l&&l.id===e.id,hover:r&&r.id===e.id,accepted:"accepted"===u,rejected:"rejected"===u});return(0,ze.jsx)(He.HC,{actions:S,className:E,title:B,id:e.id,onClick:()=>{s.issueCommand(new o(e,!1))},onMouseEnter:f,onMouseLeave:v})},{BLURS:gs}=_e.Z.WORKSHOP,ms=({onClose:e,manager:t})=>{const s=(0,Ve.b)(),i=(0,zt.z)(),{commandBinder:n}=(0,Je.useContext)(tt.I),a=ds(),r=(0,Je.useCallback)((()=>{n.issueCommand(new je.rf),i.trackToolGuiEvent("blur","blur_suggestion_list_click_accept_all"),e()}),[n,e,i]),o=(0,Je.useCallback)((async()=>{await t.rejectAllSuggestions()&&(i.trackToolGuiEvent("blur","blur_suggestion_list_click_reject_all"),e())}),[t,e,i]);if(!(null==a?void 0:a.length))return null;const l=a.length,u=s.t(gs.SUGGESTIONS_FOUND_MESSAGE,l),d=(0,ze.jsxs)(He.hE,Object.assign({spacing:"small"},{children:[(0,ze.jsx)(He.zx,{variant:He.Wu.PRIMARY,size:He.qE.SMALL,onClick:r,label:s.t(gs.ACCEPT_ALL_SUGGESTIONS)}),(0,ze.jsx)(He.zx,{variant:He.Wu.TERTIARY,size:He.qE.SMALL,onClick:o,label:s.t(gs.REJECT_ALL_SUGGESTIONS)})]})),c=(0,ze.jsx)(He.zx,{size:He.qE.LARGE,variant:He.Wu.TERTIARY,onClick:e,className:"blur-banner-exit",icon:"back",label:s.t(gs.CLOSE_SUGGESTIONS)});return(0,ze.jsx)("div",Object.assign({className:"suggestion-list-header"},{children:(0,ze.jsx)(He.jL,{text:u,actions:d,header:c})}))},{BLURS:ps}=_e.Z.WORKSHOP,bs=({group:e})=>{const{id:t,title:s,items:i}=e;return(0,ze.jsx)(He._m,{id:t,title:s,decals:(0,ze.jsx)("span",Object.assign({className:"mp-list-item-text"},{children:`(${i.length})`}))})},fs=({group:e})=>{const{id:t,items:s}=e;return(0,ze.jsx)(ns.J,{id:t,numItems:s.length})},vs=({item:e,onResolved:t})=>{const s=(0,Ve.b)();if(!e){const e=s.t(ps.NO_SUGGESTIONS_ON_FLOOR);return(0,ze.jsx)(He.gQ,{message:e})}return(0,ze.jsx)(hs,{suggestion:e,onResolved:t})},Ss=({className:e,manager:t,onClose:s})=>{const i=ds(),n=(0,zt.z)(),a=(0,Ve.b)(),{groups:r,groupBy:o,setGroupBy:l}=Xt(i),u=(0,Je.useCallback)((e=>{n.trackToolGuiEvent("blur",`blur_suggestion_list_group_by_${e.toLowerCase()}`),l(e)}),[n,l]),d=(0,Je.useCallback)(((e,s)=>{t.debouncedNavigateToNextSuggestion(r,e)}),[t,r]);if(!i)return null;const c=et()(e,"suggestion-list"),h=a.t(ps.NO_SUGGESTIONS);return(0,ze.jsxs)("div",Object.assign({className:c},{children:[(0,ze.jsxs)("header",Object.assign({className:"suggestion-list-header"},{children:[(0,ze.jsx)(ms,{manager:t,onClose:s}),(0,ze.jsx)(He.w0,{children:(0,ze.jsx)(Gt,{value:o,onChange:u})})]})),(0,ze.jsx)("div",Object.assign({className:"suggestion-list-content"},{children:0===r.length?(0,ze.jsx)(He.gQ,{message:h,itemHeight:42}):(0,ze.jsx)(He.UQ,{ariaExpandLabel:a.t(_e.Z.ACCORDIONS.EXPAND),ariaCollapseLabel:a.t(_e.Z.ACCORDIONS.COLLAPSE),data:r,itemHeight:42,renderItem:vs,renderItemProps:{onResolved:d},renderGroup:o===Ot.FLOORS?fs:bs})}))]}))};const{BLURS:Bs}=_e.Z.WORKSHOP;function Es(){const{analytics:e,commandBinder:t}=(0,Je.useContext)(tt.I),[s,n]=(0,Je.useState)(!1),a=wt(),r=(0,Ve.b)(),o=function(){var e;const t=wt(),[s,i]=(0,Je.useState)((null===(e=null==t?void 0:t.getByStatus(T.Q.PROCESSING))||void 0===e?void 0:e.length)||0);return(0,Je.useEffect)((()=>{if(!t)return()=>{};function e(){t&&i(t.getByStatus(T.Q.PROCESSING).length)}const s=t.makeProcessingSubscription(e);return e(),()=>s.cancel()}),[t]),s}(),l=function(){var e;const t=wt(),[s,i]=(0,Je.useState)((null===(e=null==t?void 0:t.getByStatus(T.Q.PENDING,T.Q.FAILED))||void 0===e?void 0:e.length)||0);return(0,Je.useEffect)((()=>{if(!t)return()=>{};function e(){t&&i(t.getByStatus(T.Q.PENDING,T.Q.FAILED).length)}const s=[t.makeUnappliedSubscription(e),t.blurs.onElementChanged({onAdded:e,onRemoved:e})];return e(),()=>{s.forEach((e=>e.cancel()))}}),[t]),s}(),u=Tt(),d=(0,Je.useCallback)((async()=>{if(!a||0===l)return;n(!0),e.trackToolGuiEvent("blur","blur_click_apply");if(await Ze(a,t,!1))return t.issueCommand(new C.Mh).finally((()=>{n(!1)}));n(!1)}),[l,a,e,t]),c=o>0,h=l>0,g=u===i.PAINTING,m=h&&!c&&!s&&!g,p=c?r.t(Bs.APPLYING,o):r.t(Bs.APPLY_BLURS_CTA,l);return(0,ze.jsx)(He.zx,{className:"apply-blurs-button",variant:He.Wu.TERTIARY,disabled:!m,size:He.qE.SMALL,onClick:d,label:p})}const{BLURS:Cs}=_e.Z.WORKSHOP;function ws({manager:e,className:t}){const s=yt(),n=ds(),{commandBinder:r}=(0,Je.useContext)(tt.I),o=(0,Ve.b)(),l=Tt(),u=!At(),d=l===i.SUGGESTING,c=et()(t,"blurs-panel"),h=(0,Je.useCallback)((e=>{const t=d?i.IDLE:i.SUGGESTING;r.issueCommand(new a(t)),e&&e.stopPropagation()}),[d,r]);if(!s||!n)return null;const g=d?o.t(Cs.NUM_BLUR_SUGGESTIONS,n.length):o.t(Cs.NUM_TYPE,s.length),m=u&&!d?(0,ze.jsx)(Es,{}):void 0,p=u?o.t(Cs.BANNER_WARNING):o.t(Cs.DEFURNISH_WARNING),b=u||!d?(0,ze.jsx)("div",Object.assign({className:"views-banner"},{children:(0,ze.jsx)(He.jL,{text:p,layout:"horizontal"})})):void 0;return(0,ze.jsxs)(Lt.L,Object.assign({toolId:M.w1.BLUR,className:c,title:g,controls:m,subheader:b},{children:[u&&d&&(0,ze.jsx)(Ss,{className:"blurs-panel-contents",manager:e,onClose:h}),u&&!d&&(0,ze.jsx)(us,{className:"blurs-panel-contents",manager:e})]}))}class ys{constructor(e,t){this.renderPanel=()=>(0,ze.jsx)(ws,{manager:this.manager}),this.renderOverlay=()=>(0,ze.jsx)(Rt,{}),this.manager=e}}var Ts=s(64150),xs=s(33315),Is=s(10835),Ds=s(84376);class As extends m.Y{constructor(){super(...arguments),this.name="blur_editor",this.activeBindings=[],this.setMeshCursorVisibility=()=>!this.data.hoveredBlur&&this.data.toolState!==i.PAINTING,this.changeToolState=async e=>{const t=this.data.toolState;e!==t&&(this.data.toolState=e,this.data.commit(),await this.onToolStateChange(e,t))},this.navigateToBlur=(e,t)=>{if(!e)throw new Error("Cannot navigate to non-existant blur");let s;const n=this.getFocalPoint(e.dots);if(n){const t=this.sweepData.getSweep(e.sweepId);n.applyQuaternion(t.rotation),s=(0,k.Z)((new g.Quaternion).setFromUnitVectors(P.fU.FORWARD,n))}let r=L.nF.Interpolate;const o=this.sweepData.currentSweepObject;if(o){const t=this.sweepData.getSweep(e.sweepId);o.neighbours.includes(t.id)||(r=L.nF.FadeToBlack)}const l=new O.ju({transition:r,sweep:e.sweepId,rotation:s}),u=this.engine.commandBinder.issueCommand(l).then((()=>{this.data.selectedBlur=e||null}));return t&&this.engine.commandBinder.issueCommand(new a(i.IDLE)),this.toolData.toolPanelLayout===M.wS.BOTTOM_PANEL&&this.engine.commandBinder.issueCommand(new U.Fg(!0)),u},this.onToolStateChange=async(e,t)=>{const{brush:s}=this.data;t===i.PAINTING&&await this.engine.commandBinder.issueCommand(new C.o8),e===i.PAINTING?(s.enable(),this.engine.broadcast(new G.ps(!1)),this.engine.commandBinder.issueCommand(new N.t)):(s.disable(),this.engine.broadcast(new G.ps(!0)),this.engine.commandBinder.issueCommand(new N.U)),e===i.OFF?(this.activeBindings.forEach((e=>e.cancel())),this.data.selectedBlur=null,this.data.hoveredBlur=null,this.data.interactions.openedTool=!1,this.data.interactions.commit(),this.renderer.setBlurs([])):this.activeBindings.forEach((e=>e.renew())),e!==i.OFF&&(this.data.selectedBlur=null,this.data.hoveredBlur=null,this.data.interactions.openedTool||(this.data.interactions.openedTool=!0,this.data.interactions.commit()),e===i.SUGGESTING?this.renderSuggestions():this.renderBlurs()),this.updatePolling()},this.checkForUpdates=()=>{let e;return(0,f.k1)((()=>{clearInterval(e),e=window.setInterval((()=>{this.log.debug("Polling..."),this.engine.commandBinder.issueCommand(new C.s$)}),1e3*Ie.F8)}),(()=>{window.clearInterval(e)}),!1)},this.onViewmodeChange=e=>{const{toolState:t}=this.data;e!==R.Ey.Panorama&&t===i.PAINTING&&this.changeToolState(i.IDLE),e===R.Ey.Panorama?this.clickHandler.renew():this.clickHandler.cancel()},this.onSweepChange=e=>{const{selectedBlur:t}=this.data;t&&(this.onDeselectBlur(t),this.data.selectedBlur=null)},this.onBlursChanged=()=>{const{selectedBlur:e}=this.data;e&&!this.blurData.isEditable(e.id)&&(this.data.selectedBlur=null);const{toolState:t}=this.data;t!==i.SUGGESTING&&this.renderBlurs()},this.onSuggestionsChanged=()=>{const e=this.toolData.getTool(M.w1.BLUR);if(e){const t=this.suggestionData.getByAccepted(null).length>0;e.hasUpdates!==t&&(e.hasUpdates=t,e.commit())}if(!this.data)return;const{toolState:t}=this.data;t===i.SUGGESTING&&this.renderSuggestions()},this.onPointerButton=e=>{const{toolState:t}=this.data,{hit:s}=this.raycasterData;e.down&&t===i.PAINTING&&this.updateSelectedBlur(s?s.object:null)},this.onKeyEvent=e=>{const{selectedBlur:t}=this.data;if(t&&e.state===Te.M.PRESSED)switch(e.key){case xe.R.ESCAPE:this.engine.commandBinder.issueCommand(new a(i.IDLE));break;case xe.R.DELETE:this.data.selectedBlur&&this.engine.commandBinder.issueCommand(new C.TL(t.id))}},this.onClick=(e,t)=>{const{toolState:s}=this.data;return s===i.PAINTING||!!(t instanceof ee||this.data.selectedBlur)&&(this.updateSelectedBlur(t),!0)},this.onPaint=(e,t,s,i)=>{const n=this.sweepData.currentSweepObject;if(!n)return;let a=this.data.selectedBlur instanceof w.x?this.data.selectedBlur:null;const r=a?a.dotCount:0;(!a||r>Ie.Vw)&&(a=new w.x({sweepId:n.id}),n.placementType!==Ds.hU.UNPLACED&&(a.floorId=n.floorId,a.roomId=n.roomId),this.blurData.add(a),this.data.selectedBlur=a);const o=e.clone().applyQuaternion(n.rotation.clone().invert()).normalize();a.add(o,t,s,i)},this.updateHoveredBlur=()=>{const{toolState:e}=this.data,t=this.raycasterData.hit&&this.raycasterData.hit.object,s=e===i.PAINTING?null:this.getBlurFromMesh(t);if(s!==this.data.hoveredBlur&&(this.data.hoveredBlur=s,this.data.toolState!==i.PAINTING)){const e=s?D.C.FINGER:null;this.engine.commandBinder.issueCommand(new I.u(e))}}}async init(e,t){this.log.debug("Module config",e),this.engine=t,this.config=e,[this.blurData,this.cameraData,this.cursorController,this.raycasterData,this.settings,this.storageData,this.sweepData,this.toolData,this.viewmodeData]=await Promise.all([t.market.waitForData(y.f),t.market.waitForData(x.M),t.getModuleBySymbol(p.Lk),t.market.waitForData(A.P),t.getModuleBySymbol(b.Ak),t.market.waitForData(xs.Q),t.market.waitForData(v.Z),t.market.waitForData(j.t),t.market.waitForData(_.O)]);const[s,n,h,m]=await Promise.all([t.getModuleBySymbol(p.PZ),t.getModuleBySymbol(p.tA),t.market.waitForData(_.O),t.getModuleBySymbol(p.Aj)]);this.suggestionData=await t.market.waitForData(Ge.a),this.bindings.push(this.toolData.onChanged(this.onSuggestionsChanged),this.suggestionData.onChanged(this.onSuggestionsChanged));const f=(await t.getModuleBySymbol(p.RR)).getRenderer();this.data=new ye,t.market.register(this,ye,this.data),this.cursorController.addVisibilityRule(this.setMeshCursorVisibility);const C=m.getScene();this.renderer=new fe(this.sweepData,this.data,C,s,n,m.cwfRenderer,f),t.addComponent(this,this.renderer);const w=new X(this.sweepData,this.cameraData,C,s);w.setSizeRange(Ie.oR,Ie.rC),w.onPaint=this.onPaint,t.addComponent(this,w),this.data.brush=w,this.registerSettings(),this.registerTool(),this.clickHandler=s.registerPriorityHandler(S.Rd,g.Mesh,this.onClick),this.bindings.push(t.commandBinder.addBinding(a,(async e=>this.changeToolState(e.state))),t.commandBinder.addBinding(r,(async e=>this.data.brush.scale=e.scale)),t.commandBinder.addBinding(o,(async({blur:e,resetBlurTool:t})=>this.navigateToBlur(e,t))),t.commandBinder.addBinding(u,(({ids:e})=>this.showBlurs(...e))),t.commandBinder.addBinding(d,(({ids:e})=>this.hideBlurs(...e))),t.commandBinder.addBinding(l,(async({id:e})=>this.batchToggleVisibility([e]))),t.commandBinder.addBinding(c,(async({ids:e})=>this.batchToggleVisibility(e)))),this.pollingSubscription=this.checkForUpdates(),this.updatePolling(),this.activeBindings.push(h.makeModeChangeSubscription(this.onViewmodeChange),this.sweepData.makeSweepChangeSubscription(this.onSweepChange),this.blurData.blurs.onChanged(this.onBlursChanged),s.registerHandler(B.er,this.onPointerButton),s.registerHandler(E.e,this.onKeyEvent),this.raycasterData.onChanged(this.updateHoveredBlur),this.clickHandler,this.storageData.onPropertyChanged("transactionState",(()=>this.updatePolling())),this.blurData.makeProcessingSubscription((()=>this.updatePolling()))),this.changeToolState(i.OFF),this.viewmodeData.currentMode&&this.onViewmodeChange(this.viewmodeData.currentMode),this.activeBindings.forEach((e=>e.cancel())),e.debug&&this.log.info("DEBUG mode enabled")}dispose(e){super.dispose(e),this.pollingSubscription&&this.pollingSubscription.cancel(),this.activeBindings.forEach((e=>e.cancel())),e.disposeRenderLayer(this.name),this.data&&e.market.unregister(this,ye),this.cursorController.removeVisibilityRule(this.setMeshCursorVisibility)}renderBlurs(){const e=this.blurData.getByStatus(T.Q.PENDING,T.Q.PROCESSING,T.Q.FAILED).filter((e=>e.visible));this.renderer.setBlurs(e)}renderSuggestions(){const e=this.suggestionData.getByAccepted(!0,null).filter((e=>e.visible));this.renderer.setBlurs(e)}getFocalPoint(e){if(!e.length)return null;let t=0;const s=e.reduce(((e,s)=>{for(const i of s.directions)e.x+=i.x,e.y+=i.y,e.z+=i.z,t++;return e}),{x:0,y:0,z:0});return new g.Vector3(s.x/t,s.y/t,s.z/t)}async showBlurs(...e){this.blurData.setVisibility(!0,...e)}async hideBlurs(...e){this.blurData.setVisibility(!1,...e)}batchToggleVisibility(e){this.blurData.batchToggleVisibility(e)}updatePolling(){const{toolState:e}=this.data,{transactionState:t}=this.storageData,s=e!==i.OFF,n=t===Is.g.IDLE;return s&&n?(this.pollingSubscription.renew(),this.log.debug("Polling enabled"),!0):(this.log.debug("Polling disabled"),this.pollingSubscription.cancel(),!1)}onDeselectBlur(e){const{toolState:t}=this.data;e&&t===i.PAINTING&&this.engine.commandBinder.issueCommand(new C.o8)}getBlurFromMesh(e){if(e&&e instanceof ee){const t=this.data.toolState===i.SUGGESTING,s=t?this.suggestionData.get(e.blurId):this.blurData.get(e.blurId);if(t||(null==s?void 0:s.status)===T.Q.PENDING)return s}return null}updateSelectedBlur(e){const t=this.getBlurFromMesh(e);t!==this.data.selectedBlur&&(this.onDeselectBlur(this.data.selectedBlur),this.data.selectedBlur=t,t&&this.log.debug(`Selected blur ${t.id}`))}registerSettings(){const e="Blur Tool",{brush:t}=this.data,{debug:s,meshBlurEnabled:i,pipelineEnabled:n}=this.config;[{header:e,setting:"blur/brush_size",range:[Ie.oR,Ie.rC],initialValue:()=>t.size,onChange:e=>t.size=e},{header:e,setting:"blur/brush_scale",range:[0,1],initialValue:()=>t.scale,onChange:e=>t.scale=e},{header:e,setting:"blur/tool_enabled",initialValue:()=>this.settings.tryGetProperty(Ie.x3,!1),onChange:e=>this.settings.updateSetting(Ie.x3,e)},{header:e,setting:"blur/mask",initialValue:()=>!1,onChange:e=>{this.renderer&&this.renderer.setMaskVisibility(e)}},{header:e,setting:"blur/show_cursor",initialValue:()=>!1,onChange:e=>{this.log.debug("Brush mouse cursor "+(e?"enabled":"disabled")),t.toggleMouseCursor(e)}},{header:e,setting:Ie.Vk,initialValue:()=>s,onChange:e=>{this.settings.updateSetting(Ie.Vk,e)}},{header:e,setting:re.pv,initialValue:()=>!1,onChange:e=>{this.settings.updateSetting(re.pv,e)}},{header:e,setting:re.n5,initialValue:()=>n,onChange:e=>{this.settings.updateSetting(re.n5,e)}},{header:e,setting:re.i7,initialValue:()=>i,onChange:e=>{this.settings.updateSetting(re.i7,e)}}].forEach((e=>this.settings.registerMenuEntry(e)))}async registerTool(){const e=await this.engine.market.waitForData(Ts.e),t=new Ke(this.engine,e),s=new F.U({id:M.w1.BLUR,namePhraseKey:_e.Z.TOOLS.BLUR,panel:!0,icon:"icon-blur-outline",analytic:"blur",palette:M.$r.MODEL_BASED,allViewsPhraseKey:_e.Z.WORKSHOP.LAYERS.APPLY_TO_ALL_VIEWS_BLURS,order:90,dimmed:!1,enabled:e.tryGetProperty(Ie.x3,!1),manager:t,ui:new ys(t,e),featureFlag:Ie.x3,helpMessagePhraseKey:_e.Z.TOOLS.BLUR_HELP_MESSAGE,helpHref:"https://support.matterport.com/hc/en-us/articles/1500003156162-How-to-use-Manual-Blur-Brush"});this.engine.commandBinder.issueCommand(new U.MV([s]))}}},63308:(e,t,s)=>{"use strict";s.d(t,{a:()=>r});var i=s(42141),n=s(42896),a=s(28721);class r extends i.V{constructor(e){super(),this.name="blur-suggestion-data",this.suggestions=new n.v,e&&this.add(...e)}add(...e){this.suggestions.atomic((()=>{for(const t of e)t.atomic((()=>{for(;!t.id||this.suggestions.has(t.id);)t.id=(0,a.O1)(11),t.commit();if(-1===t.index||this.hasIndex(t.index)){const e=this.suggestions.values.map((e=>e.index)).filter((e=>"number"==typeof e)),s=e.length?Math.max(...e):0;t.index=s+1,t.commit()}})),this.suggestions.set(t.id,t)})),this.commit()}has(e){return this.suggestions.has(e)}hasIndex(e){return!!this.suggestions.values.find((t=>t.index===e))}get(e){return this.suggestions.get(e)}getByAccepted(...e){return this.suggestions.values.filter((t=>e.includes(t.accepted)))}accept(...e){return this.updateAll(e,{accepted:!0})}reject(...e){return this.updateAll(e,{accepted:!1})}reset(...e){return this.updateAll(e,{accepted:null})}show(...e){return this.updateAll(e,{visible:!0})}hide(...e){return this.updateAll(e,{visible:!1})}updateAll(e,t){const s=e.length?e:this.suggestions.keys;this.atomic((()=>{this.suggestions.atomic((()=>{for(const e of s)if(this.has(e)){const s=this.get(e);Object.assign(s,t),s.commit()}})),this.commit()}))}}},13268:(e,t,s)=>{"use strict";s.d(t,{ee:()=>a,mA:()=>r,oA:()=>l,qY:()=>n,rf:()=>o});var i=s(56063);class n extends i.m{}n.id="SAVE_BLUR_SUGGESTIONS";class a extends i.m{constructor(...e){super(),this.payload={ids:e}}}a.id="SHOW_BLUR_SUGGESTIONS";class r extends i.m{constructor(...e){super(),this.payload={ids:e}}}r.id="HIDE_BLUR_SUGGESTIONS";class o extends i.m{constructor(...e){super(),this.payload={ids:e}}}o.id="ACCEPT_BLUR_SUGGESTIONS";class l extends i.m{constructor(...e){super(),this.payload={ids:e}}}l.id="REJECT_BLUR_SUGGESTIONS"},53573:(e,t,s)=>{"use strict";s.r(t),s.d(t,{BlurSuggestionData:()=>i.a,default:()=>L});var i=s(63308),n=s(933),a=s(34608),r=s(4763),o=s(83069),l=s(68661),u=s(4218),d=s(35213),c=s(77543),h=s(32580),g=s(35659),m=s(37137);class p{constructor(e){this.config=e}async read(){const{url:e,deserializer:t,format:s,queue:i}=this.config;let n=await i.get(e);return"json"===s&&(n=JSON.parse(n)),t?t(n):n}}var b=s(31740),f=s(27067),v=s(35780),S=s(13268),B=s(43606),E=s(64831),C=s(28721);class w extends E.T{constructor(e){super(),this.accepted=null,this.index=-1,this.classification=[],this.visible=!0,this.editable=!1,this.id=(0,C.O1)(11),e&&Object.assign(this,e)}}var y=s(53330),T=s(53257),x=s(38256);const I=new T.Z("blurSuggestionDeserializer");function D(e){const t=function(e){return function(t){const s=(0,y.LB)(null==t?void 0:t.dots),i=e.getSweepByUuid(null==t?void 0:t.sweepId);if(!(t&&s&&s.length&&i))return I.debug("Deserialized invalid Blur suggestion",t),null;const n=!0===t.accepted||!1===t.accepted?t.accepted:null;return new w({id:t.sid,accepted:n,dots:s,index:t.index,floorId:i.floorId,roomId:i.roomId,sweepId:i.id,classification:t.tags||[],visible:!0,created:(0,x.p)(t.created),modified:(0,x.p)(t.modified)})}}(e);return function(e){const s={};for(const i in e){const n=t(e[i]);n&&(s[i]=n)}return s}}var A=s(13851);function _(e){const t=function(e){return function(t){const s=e.getSweep(t.sweepId),i=(0,A.o_)(t.dots);return s&&(null==i?void 0:i.length)?{sid:t.id,accepted:t.accepted,dots:i,index:t.index,sweepId:s.uuid,tags:t.classification,visible:t.visible,created:(0,x.U)(t.created),modified:(0,x.U)(t.modified)}:null}}(e);return function(e){const s={};for(const i in e){const n=t(e[i]);n&&(s[i]=n)}return s}}class R extends B.MU{constructor(e){const{queue:t,baseUrl:s,modelId:i,sweepData:n}=e;super({queue:t,path:`${s}/api/v1/jsonstore/model/blur-suggestions/${i}`,batchUpdate:!0,deserialize:D(n),serialize:_(n)}),this.baseUrl=s,this.modelId=i}async read(){const e=await super.read();return Object.values(e||{})}async reset(){var e;const{queue:t}=this.config,s=`${this.baseUrl}/api/v1/jsonstore/model/blur-suggestions/${this.modelId}`;if(!(null===(e=this.modelId)||void 0===e?void 0:e.length))throw new Error(`Refusing to DELETE ${s}`);if(window.confirm("Are you sure you want to reset all suggestions? This cannot be undone."))return t.delete(s,this.options).then((()=>{window.location.reload()}))}}function O(e){return t=>{const s=[];if(!(null==t?void 0:t.blurs))return[];const i=Object.values(t.blurs).filter((e=>!e.blurEnabled));for(const t of i){const i=e.getSweepByUuid(t.sweepId),n=(0,y.LB)(t.dots);if(!(null==n?void 0:n.length)||!i||!Array.isArray(null==t?void 0:t.dots))continue;const a=new w({accepted:null,sweepId:i.id,dots:n,classification:["face"],floorId:i.floorId||void 0,visible:!0});s.push(a)}return s}}class L extends n.Y{constructor(){super(...arguments),this.name="blur-suggestions"}async init(e,t){this.engine=t,this.config=e,await this.load(),await this.registerSettings()}async load(){const{baseUrl:e,modelId:t,queue:s,readonly:n}=this.config,{market:a,commandBinder:l}=this.engine,[c,h]=await Promise.all([a.waitForData(d.f),a.waitForData(b.Z)]);this.blurData=c,this.store=new R({queue:s,baseUrl:e,modelId:t,sweepData:h}),this.data=new i.a;const p=this.store.read();if(this.log.debug("Loaded existing suggestions",p),p&&p.then((async e=>{if(this.data)if(0===e.length){const e=await this.getSuggestionsFromVision();if(!this.data||0===e.length)return;this.data.add(...e),this.log.debug(`Importing ${e.length} suggestions from Vision...`),l.issueCommand(new S.qY)}else this.data.add(...e||[])})),!n){const e=await this.engine.getModuleBySymbol(r.Lx);this.bindings.push(l.addBinding(S.qY,(()=>l.issueCommand(new m.V({dataTypes:[g.g.BLUR_SUGGESTIONS]})))),l.addBinding(S.rf,(({ids:e})=>this.accept(...e))),l.addBinding(S.oA,(({ids:e})=>this.reject(...e))),l.addBinding(S.ee,(({ids:e})=>this.show(...e))),l.addBinding(S.mA,(({ids:e})=>this.hide(...e))),e.onSave((()=>this.save()),{dataType:g.g.BLUR_SUGGESTIONS}))}a.register(this,i.a,this.data),n||(this.monitor=new u.c(this.data.suggestions,{aggregationType:o.E.Manual}))}dispose(e){super.dispose(e),e.market.unregister(this,i.a),this.data=void 0}async accept(...e){const{commandBinder:t}=this.engine,s=e.length?e.map((e=>this.data.get(e))):this.data.getByAccepted(null),i=s.map((e=>c.x.from(e)));return this.blurData.add(...i),this.data.accept(...s.map((e=>e.id))),Promise.all([t.issueCommand(new h.o8),t.issueCommand(new S.qY)]).then((()=>{}))}async reject(...e){const{commandBinder:t}=this.engine,s=e.length?e:this.data.getByAccepted(null).map((e=>e.id));return this.data.reject(...s),t.issueCommand(new S.qY)}async show(...e){this.data.show(...e)}async hide(...e){this.data.hide(...e)}async save(){const{readonly:e}=this.config;if(e||!this.monitor)return;this.monitor.commitChanges();const t=this.monitor.getDiffRecord();if(this.monitor.clearDiffRecord(),!t.length)return;const s={};for(const e of t)switch(e.action){case l.KI.added:case l.KI.updated:s[e.index]=this.data.get(e.index);break;case l.KI.removed:s[e.index]=null}return this.store.update(s).catch((e=>{this.log.error(e)}))}async getSuggestionsFromVision(){const{market:e}=this.engine,[t,s]=await Promise.all([e.waitForData(v.R),e.waitForData(b.Z)]);let i=null;const n=t.objectBlur;if(null==n?void 0:n.url){const e=new p({url:n.url,queue:this.config.queue||new f.gO,format:"json",deserializer:O(s)});i=await e.read()}return i||[]}async registerSettings(){const e=await this.engine.getModuleBySymbol(a.Ak),{debug:t}=this.config;t&&e.registerMenuButton({header:"Blur Suggestions",buttonName:"Reset Suggestions",callback:()=>{this.store.reset()}})}}},35780:(e,t,s)=>{"use strict";s.d(t,{R:()=>n});var i=s(42141);class n extends i.V{constructor(e=[]){super(),this.catalog=e}get objectAnnotations(){return this.catalog.find((e=>"objectAnnotations"===e.name))}get semantic(){return this.catalog.find((e=>"semantic"===e.name))}get detectedObjects(){return this.catalog.find((e=>"detectedObjects"===e.name))}get objectBlur(){return this.catalog.find((e=>"objectBlur"===e.name))}getCatalog(){return this.catalog}getAsset(e){return this.catalog.find((t=>t.name===e))}findFilename(e){return this.catalog.find((t=>t.url.includes(e)))}}},48359:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>c});var i=s(933),n=s(35780),a=s(5244),r=s(2942),o=s(93797),l=s(38256);class u extends o.u{constructor(e,t=!1){super(e),this.loadCatalog=t}async read(){return this._readAssets().then((e=>!e.length||this.loadCatalog?this._readCatalog():e))}_readAssets(){const e={modelId:this.getViewId()};return this.query(a.GetVisionAssets,e).then((e=>{var t,s;const i=[],n=null===(s=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===s?void 0:s.objectBlur;return(null==n?void 0:n.url)&&i.push({name:"objectBlur",contentType:n.contentType||"unknown",format:n.format,url:n.url,validUntil:(0,l.p)(n.validUntil)}),i}))}_readCatalog(){const e={modelId:this.getViewId()};return this.query(r.GetVisionCatalog,e).then((e=>{var t,s,i;const n=(null===(i=null===(s=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===s?void 0:s.assets)||void 0===i?void 0:i.catalog)||[],a=[];return n.forEach((e=>{if(null==e?void 0:e.url){let t=e.type||"unknown";"unknown"===t&&e.url.match(/object\//i)&&(t="objectAnnotations"),"unknown"===t&&e.url.match(/blur/i)&&(t="objectBlur"),"unknown"===t&&e.url.match(/detected/i)&&(t="detectedObjects"),"unknown"===t&&e.url.includes("semantic/room_boundaries.json")&&(t="room-bounds"),a.push({name:t,format:e.format,url:e.url,contentType:e.format,validUntil:(0,l.p)(e.validUntil)})}})),a}))}}var d=s(22925);class c extends i.Y{constructor(){super(...arguments),this.name="vision-catalog"}async init(e,t){const s=await t.market.waitForData(d.R),i=new u({context:s.mdsContext,readonly:!0,viewId:e.baseModelId},e.loadCatalog),a=await i.read().catch((e=>(this.log.info("Failed to load Vision Catalog"),[])));this.data=new n.R(a),t.market.register(this,n.R,this.data)}dispose(e){super.dispose(e),e.market.unregister(this,n.R)}}},77543:(e,t,s)=>{"use strict";s.d(t,{x:()=>r});var i=s(64831),n=s(28721),a=s(71772);class r extends i.T{constructor(e){super(),this.dots=[],this.status=a.Q.PENDING,this.floorId=null,this.roomId=null,this.visible=!0,this.created=new Date,this.modified=new Date,this.id=(0,n.O1)(11),this.index=-1,e&&Object.assign(this,e)}get editable(){return r.editableStatus.includes(this.status)}add(e,t,s,i){let n=this.dots.find((e=>e.radius===t&&e.feather===s&&e.strength===i));n||(n={radius:t,feather:s,strength:i,directions:[]},this.dots.push(n)),n.directions.push(e),this.modified.setTime(Date.now()),this.commit()}static from(e){return new r({status:a.Q.PENDING,dots:e.dots,sweepId:e.sweepId,floorId:e.floorId||null})}get dotCount(){return this.dots.reduce(((e,t)=>e+t.directions.length),0)}get sid(){return this.id}}r.editableStatus=[a.Q.FAILED,a.Q.PENDING]},35213:(e,t,s)=>{"use strict";s.d(t,{f:()=>u});var i=s(42141),n=s(42896),a=s(85726),r=s(28721),o=s(53257),l=s(71772);new o.Z("BlurData");class u extends i.V{constructor(e){super(),this.name="blur-data",this.blurs=new n.v,this._hasProcessing=new a.f(!1),this._hasUnapplied=new a.f(!1),e&&this.add(...Object.values(e))}add(...e){this.atomic((()=>{this.blurs.atomic((()=>{for(const t of e)t.atomic((()=>{for(;!t.id||this.blurs.has(t.id);)t.id=(0,r.O1)(11),t.commit();if(-1===t.index||this.hasIndex(t.index)){const e=this.blurs.values.map((e=>e.index)).filter((e=>"number"==typeof e)),s=e.length?Math.max(...e):0;t.index=s+1,t.commit()}})),this.blurs.set(t.id,t)})),this.update(),this.commit()}))}delete(...e){return this.atomic((()=>{this.blurs.atomic((()=>{e.filter((e=>this.isEditable(e)&&this.blurs.delete(e)))})),this.update(),this.commit()})),e.length}get(e){return this.blurs.get(e)}getEditable(){return this.blurs.values.filter((e=>e.editable))}getBySweepId(e,t=null){return this.blurs.values.filter((s=>s.sweepId===e&&(null===t||s.visible===t)))}getByStatus(...e){return e.length?this.blurs.values.filter((t=>e.includes(t.status))):this.blurs.values}batchToggleVisibility(e){const t=e.some((e=>{const t=this.blurs.get(e);return!!t&&!t.visible}));for(const s of e){const e=this.blurs.get(s);e&&(e.visible=t,e.commit())}}has(e){return this.blurs.has(e)}hasIndex(e){return!!this.blurs.values.find((t=>t.index===e))}hasStatus(e){return this.blurs.values.some((t=>t.status===e))}hasUnappliedBlurs(){return this.blurs.values.some((e=>e.status===l.Q.PENDING||e.status===l.Q.FAILED))}hasAppliedBlurs(){return this.blurs.values.some((e=>e.status===l.Q.PROCESSING||e.status===l.Q.APPLIED||e.status===l.Q.FAILED))}hasProcessingBlurs(){return this.hasStatus(l.Q.PROCESSING)}setVisibility(e,...t){this.atomic((()=>{this.blurs.atomic((()=>{for(const s of t)if(this.has(s)){const t=this.blurs.get(s);t.visible=e,t.modified.setTime(Date.now()),t.commit()}})),this.commit()}))}setStatus(e,...t){this.atomic((()=>{this.blurs.atomic((()=>{for(const s of t)if(this.has(s)){const t=this.blurs.get(s);t.status=e,t.modified.setTime(Date.now()),t.commit()}})),this.update(),this.commit()}))}isEditable(e){if(!this.has(e))return!1;return this.get(e).editable}makeProcessingSubscription(e){return this._hasProcessing.onChanged(e)}makeUnappliedSubscription(e){return this._hasUnapplied.onChanged(e)}update(){let e=!1;const t=this.hasProcessingBlurs();t!==this._hasProcessing.value&&(this._hasProcessing.value=t,e=!0);const s=this.hasUnappliedBlurs();s!==this._hasUnapplied.value&&(this._hasUnapplied.value=s,e=!0),e&&this.commit()}onChanged(e){return super.onChanged(e)}}},71772:(e,t,s)=>{"use strict";var i;s.d(t,{Q:()=>i}),function(e){e.PENDING="pending",e.PROCESSING="processing",e.APPLIED="applied",e.FAILED="failed"}(i||(i={}))},32580:(e,t,s)=>{"use strict";s.d(t,{Mh:()=>l,TL:()=>n,ie:()=>r,o8:()=>a,s$:()=>o});var i=s(56063);class n extends i.m{constructor(...e){super(),this.payload={ids:e}}}n.id="DELETE_BLURS";class a extends i.m{}a.id="SAVE_BLURS";class r extends i.m{}r.id="PUBLISH_BLURS_COMMAND";class o extends i.m{}o.id="REFRESH_BLURS_COMMAND";class l extends i.m{}l.id="APPLY_BLURS_COMMAND"},54229:(e,t,s)=>{"use strict";s.r(t),s.d(t,{ApplyBlursCommand:()=>i.Mh,Blur:()=>r.x,BlurData:()=>n.f,BlurStatus:()=>a.Q,DeleteBlursCommand:()=>i.TL,PublishBlursCommand:()=>i.ie,RefreshBlursCommand:()=>i.s$,SaveBlursCommand:()=>i.o8,default:()=>y});var i=s(32580),n=s(35213),a=s(71772),r=s(77543),o=s(933),l=s(34608),u=s(4763),d=s(83069),c=s(68661),h=s(4218),g=s(35659),m=s(37137),p=s(31740),b=s(43606),f=s(28721),v=s(53257),S=s(3725),B=s(53330),E=s(13851);const C=new v.Z("BlurStore");class w extends b.MU{constructor(e){const{baseUrl:t,modelId:s,queue:i,sweepData:n}=e;super({queue:i,path:`${t}/api/v1/jsonstore/model/blurs/${s}`,batchUpdate:!0,deserialize:(0,B.B4)(n),serialize:(0,E.fM)(n)}),this.queue=i,this.baseUrl=t,this.modelId=s,this.serialize=(0,E.o2)(n)}async apply(e,{useChunks:t,meshBlurEnabled:s,pipelineEnabled:i}){if(!i)return void C.info("Pipeline disabled, no blurs will be applied to the model");const n={enableMeshBlur:s,levels:S.TW.map((e=>({size:e.size,sigmaRadians:.5*e.sigma/e.size})))},a={};for(const s of e){const e=t?s.sweepId:0,i=this.serialize(s);i&&(a[e]||(a[e]={}),a[e][s.id]=i)}const r=Object.keys(a).length,o=[];for(const e in a){const s=a[e];t&&C.debug(`Applying ${Object.values(s).length} blurs to Sweep ${e}`);const i=this.queue.post(`${this.baseUrl}/api/v2/pano-edit/${this.modelId}/blur-panos`,{withCredentials:!0,body:{blurs:s,options:n}});o.push(i),r>o.length&&(C.debug("waiting 100ms"),await(0,f.gw)(250))}return Promise.all(o)}}class y extends o.Y{constructor(){super(...arguments),this.name="blur_data",this.refreshPromise=null,this.saveBlurs=async()=>{const{commandBinder:e}=this.engine;return e.issueCommand(new m.V({dataTypes:[g.g.BLURS]}))},this.onApplyBlursCommand=()=>this.applyBlurs()}async init(e,t){this.engine=t,this.config=e,await this.load(t)}dispose(e){super.dispose(e),e.market.unregister(this,n.f),this.data=void 0}async configureStorage(){if(this.store)return;const{baseUrl:e,modelId:t,queue:s,readonly:n}=this.config,{commandBinder:a,market:r}=this.engine,o=await r.waitForData(p.Z);this.store=new w({baseUrl:e,modelId:t,queue:s,sweepData:o}),n||(this.bindings.push(a.addBinding(i.s$,(()=>this.refresh())),a.addBinding(i.Mh,this.onApplyBlursCommand),a.addBinding(i.o8,this.saveBlurs),a.addBinding(i.TL,(async({ids:e})=>this.deleteById(...e)))),this.engine.getModuleBySymbol(u.Lx).then((e=>{this.bindings.push(e.onSave((()=>this.save()),{dataType:g.g.BLURS}))})))}async load(e){await this.configureStorage(),this.settings=await e.getModuleBySymbol(l.Ak),this.data=new n.f,e.market.register(this,n.f,this.data);const t=await this.store.read();this.data.add(...Object.values(t||{})),this.monitor=new h.c(this.data.blurs,{aggregationType:d.E.Manual})}async refresh(){if(this.refreshPromise)return;if(!this.data.hasAppliedBlurs())return;const e=this.store.read().then((e=>{this.updateBlursFrom(...Object.values(e||{}))})).finally((()=>{this.refreshPromise=null}));return this.refreshPromise=e,e}async save(){if(!this.monitor||this.config.readonly)return void this.log.warn("Blur changes will NOT be saved");await this.refresh(),this.monitor.commitChanges();const e=this.monitor.getDiffRecord().filter((({index:e,action:t})=>t===c.KI.removed||this.data.has(e)&&this.data.get(e).editable));if(this.monitor.clearDiffRecord(),!e.length)return;const t={};for(const s of e)switch(s.action){case c.KI.added:case c.KI.updated:t[s.index]=this.data.get(s.index);break;case c.KI.removed:t[s.index]=null}return this.store.update(t)}async applyBlurs(){var e,t,s;if(this.data.hasProcessingBlurs())return;await this.save();const i=this.data.getByStatus(a.Q.PENDING,a.Q.FAILED);if(!i.length)return;i.length>S.Dr&&(this.log.info(`Applying Blurs: Truncating request to the maximum of ${S.Dr} Blurs. Total Pending: ${i.length}`),i.length=S.Dr),this.data.setStatus(a.Q.PROCESSING,...i.map((e=>e.id))),this.log.info(`Applying ${i.length} blurs...`);const n=null===(e=this.settings)||void 0===e?void 0:e.tryGetProperty(S.n5,!1),r=null===(t=this.settings)||void 0===t?void 0:t.tryGetProperty(S.i7,!1),o=null===(s=this.settings)||void 0===s?void 0:s.tryGetProperty(S.pv,!1);return this.store.apply(i,{useChunks:o,meshBlurEnabled:r,pipelineEnabled:n})}async deleteById(...e){if(this.data.delete(...e))return this.save()}updateBlursFrom(...e){this.data.atomic((()=>{e.forEach((e=>{if(this.data.has(e.id)){const t=this.data.get(e.id);e.status!==t.status&&(t.status=e.status,t.modified.setTime(e.modified.getTime()),t.commit())}}))}))}}},53330:(e,t,s)=>{"use strict";s.d(t,{B4:()=>h,LB:()=>g});var i=s(38256),n=s(53257),a=s(32197),r=s(77543),o=s(71772),l=s(3725),u=s(18822),d=s(84376);const c=new n.Z("blurDeserializer");function h(e){const t=function(e){return function(t){var s;const n=g(null==t?void 0:t.dots),a=e.getSweepByUuid(null===(s=null==t?void 0:t.sweepId)||void 0===s?void 0:s.replace(/-/g,""));if(!(t&&n&&n.length&&a))return c.debug("Deserialized invalid Blur",t),null;const u=new r.x({id:t.sid,index:"number"==typeof t.index?t.index:-1,status:t.status,sweepId:a.id,created:(0,i.p)(t.created)});return a.placementType!==d.hU.UNPLACED&&(u.floorId=a.floorId,u.roomId=a.roomId),n.forEach((e=>{e.directions.forEach((t=>{u.add(t,e.radius,e.feather,e.strength)}))})),u.modified=(0,i.p)(t.modified),u.status===o.Q.PROCESSING&&Date.now()-u.modified.getTime()>l.gJ&&(u.status=o.Q.FAILED),u}}(e);return function(e){const s={};for(const i of Object.values(e)){const e=t(i);e&&(s[e.id]=e)}return s}}function g(e){if(!e||!Array.isArray(e))return null;const t=[];for(const s of e)if(m(s)){const e=s.unitVectors.map((e=>a.ep.fromVisionVector({x:"string"==typeof e.x?parseFloat(e.x):e.x,y:"string"==typeof e.y?parseFloat(e.y):e.y,z:"string"==typeof e.z?parseFloat(e.z):e.z})));t.push({directions:e,radius:(0,u.d)(s.radius),feather:"string"==typeof s.feather?parseFloat(s.feather):s.feather,strength:"string"==typeof s.strength?parseFloat(s.strength):s.strength})}return t}function m(e){return["unitVectors","radius","strength","feather"].every((t=>t in e))}},13851:(e,t,s)=>{"use strict";s.d(t,{fM:()=>l,o2:()=>o,o_:()=>u});var i=s(38256),n=s(32197),a=s(16385),r=s(18822);function o(e){return function(t){if(!t)return null;const s=e.getSweep(t.sweepId),n=u(t.dots);if(!s||!(null==n?void 0:n.length))return null;return{sid:t.id,index:t.index,sweepId:s.uuid,status:t.status,dots:n,visible:t.visible,created:(0,i.U)(t.created),modified:(0,i.U)(t.modified)}}}function l(e){const t=o(e);return function(e){const s={};for(const i of Object.values(e)){const e=t(i);e&&(s[i.id]=e)}return s}}function u(e){if(!e)return null;return function(e,t=5){return e.map((e=>({unitVectors:e.unitVectors.map((e=>({x:(0,n.Zd)(e.x,t),y:(0,n.Zd)(e.y,t),z:(0,n.Zd)(e.z,t)}))),radius:(0,n.Zd)(e.radius,t),feather:(0,n.Zd)(e.feather,t),strength:(0,n.Zd)(e.strength,3)})))}(e.map((e=>({unitVectors:e.directions.map((e=>(0,a.m)(n.ep.toVisionVector(e)))),radius:(0,r.t)(e.radius),feather:e.feather,strength:e.strength}))))}},18822:(e,t,s)=>{"use strict";s.d(t,{d:()=>a,t:()=>n});var i=s(3725);function n(e){return Math.atan(e/i.U_)}function a(e){return i.U_*Math.tan(e)}},78692:(e,t,s)=>{"use strict";s.d(t,{M:()=>n});var i=s(56063);class n extends i.m{constructor(e,t,s){super(),this.payload={sweepId:e,texture:t,quaternion:s}}}n.id="SET_PANO_OVERLAY"},43606:(e,t,s)=>{"use strict";s.d(t,{MU:()=>o});var i,n=s(28721),a=s(85661);!function(e){e.GET="GET",e.POST="POST",e.PATCH="PATCH",e.PUT="PUT",e.DELETE="DELETE",e.OPTIONS="OPTIONS"}(i||(i={}));class r extends class{constructor(){this._options={responseType:"json"}}get options(){const e=this._options;return e.headers=(0,a.m)(this.url,this._options.headers||{}),e}}{constructor(e){super(),this.config=e,this.url=e.path}async read(){const{deserialize:e}=this.config;let t=null;return this.config.cachedData&&this.config.cachedData.data?t=this.config.cachedData.data:(t=await this.config.queue.get(this.config.path,this.options),this.config.cachedData&&(this.config.cachedData.data=t)),e(t)}clearCache(){this.config.cachedData&&(this.config.cachedData.data=null)}}class o extends r{constructor(e){super(e),this.config=e,this.acceptsPartial=!1,this.config.batchUpdate="batchUpdate"in this.config&&this.config.batchUpdate}async create(e){throw Error("Not implemented")}updateBatch(e,t){const{serialize:s}=this.config,n=[],a=[...new Set([...Object.keys(e),...Object.keys(t)])];for(const s of a){e[s]||t[s]||n.push(this.config.queue.delete(`${this.config.path}/${s}`,this.options))}const r=s(e,t),o=Object.assign(Object.assign({},this.options),{body:r});return n.push(this.config.queue.request(this.config.httpMethod||i.POST,this.config.path,o)),Promise.all(n)}updateInternal(e,t){const{serialize:s}=this.config,a=[],r=Object.assign({},this.options),o=Object.keys(e),l=Object.keys(t),u=(0,n.XN)(o.concat(l));for(const n in u){const o=u[n],l=e[o]||t[o];if(l){const e={};e[o]=l;const n={},u=t[o];u&&(n[o]=u);const d=s(e,n);r.body=d,a.push(this.config.queue.request(this.config.httpMethod||i.POST,this.config.path,r))}else a.push(this.config.queue.delete(`${this.config.path}/${o}`,this.options))}return Promise.all(a)}async update(e,t){this.clearCache(),await(this.config.batchUpdate?this.updateBatch(e,t||{}):this.updateInternal(e,t||{}))}async delete(e){throw Error("Not implemented")}}},65794:e=>{e.exports="precision highp float;precision highp int;uniform mat4 viewMatrix;uniform vec3 cameraPosition;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}uniform vec3 opacity;uniform vec3 radius;uniform vec3 feather;uniform vec3 color;varying vec4 vCenter;varying vec4 vPosition;void main(){float fragRadius=length(vPosition.xyz-vCenter.xyz);vec3 featherStart=radius-feather;vec3 circleAlphaWithFeather=1.-max(fragRadius-featherStart,0.)/(feather*2.);gl_FragColor=vec4(color.rgb*opacity*circleAlphaWithFeather,1.);}"},59285:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelMatrix;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform mat3 normalMatrix;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;attribute mat4 instanceMatrix;varying vec4 vCenter;varying vec4 vPosition;void main(){vPosition=instanceMatrix*vec4(position,1.);vCenter=instanceMatrix*vec4(0.,0.,0.,1.);gl_Position=projectionMatrix*modelViewMatrix*vPosition;}"},34468:e=>{e.exports="precision highp float;precision highp int;uniform mat4 viewMatrix;uniform vec3 cameraPosition;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}varying vec4 maskPosition;varying vec4 panoPosition;uniform samplerCube maskTexture;uniform samplerCube panoBlurredMap0;uniform samplerCube panoBlurredMap1;uniform samplerCube panoBlurredMap2;uniform samplerCube panoBlurredMap3;const vec4 SELECTED_OUTLINE_COLOR=vec4(1.,1.,1.,1.);const vec4 HOVER_COLOR=vec4(1.,1.,1.,1.);vec4 combineBlurs(vec4 mask,vec4 blurredColor0,vec4 blurredColor1,vec4 blurredColor2,vec4 blurredColor3){float maskAlpha=mask.r;float selectedAlpha=mask.g;float hoveredAlpha=mask.b;float targetSigma=maskAlpha*(4.*4.-1.);float blurRatio=log2(1.+targetSigma);float panoAlpha=max(1.-abs(blurRatio-0.)/1.,0.);float blurAlpha0=max(1.-abs(blurRatio-1.)/1.,0.);float blurAlpha1=max(1.-abs(blurRatio-2.)/1.,0.);float blurAlpha2=max(1.-abs(blurRatio-3.)/1.,0.);float blurAlpha3=max(1.-abs(blurRatio-4.)/1.,0.);float alpha=blurAlpha0+blurAlpha1+blurAlpha2+blurAlpha3;vec4 color=(panoAlpha*blurredColor0+blurAlpha0*blurredColor0+blurAlpha1*blurredColor1+blurAlpha2*blurredColor2+blurAlpha3*blurredColor3);color.a=alpha;float selectedMaskAlpha=smoothstep(0.65,0.75,selectedAlpha)*(1.-smoothstep(0.85,0.95,selectedAlpha));color=mix(color,SELECTED_OUTLINE_COLOR,selectedMaskAlpha);color=mix(color,HOVER_COLOR,hoveredAlpha*0.3);return color;}void main(){vec4 mask=textureCube(maskTexture,maskPosition.xyz);\n#ifdef DEBUG_BLUR_LEVELS\nmask=vec4(fract(gl_FragCoord.x/2048.),0.,0.,1.);\n#endif\nvec4 blurredColor0=textureCube(panoBlurredMap0,panoPosition.xyz);vec4 blurredColor1=textureCube(panoBlurredMap1,panoPosition.xyz);vec4 blurredColor2=textureCube(panoBlurredMap2,panoPosition.xyz);vec4 blurredColor3=textureCube(panoBlurredMap3,panoPosition.xyz);\n# ifdef DEBUG_BLUR_LEVELS\nif(gl_FragCoord.y>2000.){blurredColor0=vec4(1.,0.,0.,1.);blurredColor1=vec4(0.,1.,0.,1.);blurredColor2=vec4(0.,0.,1.,1.);blurredColor3=vec4(0.,1.,1.,1.);}\n#elif defined(DEBUG_BLUR_COLORS)\nblurredColor0=vec4(1.,0.,0.,1.);blurredColor1=vec4(0.,1.,0.,1.);blurredColor2=vec4(0.,0.,1.,1.);blurredColor3=vec4(0.,1.,1.,1.);\n#endif\ngl_FragColor=combineBlurs(mask,blurredColor0,blurredColor1,blurredColor2,blurredColor3);}"},77288:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelMatrix;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform mat3 normalMatrix;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;varying vec4 maskPosition;varying vec4 panoPosition;uniform mat4 maskMatrix;uniform mat4 panoMatrix1;uniform mat4 panoMatrix2;void main(){vec4 worldPosition=modelMatrix*vec4(position,1.);maskPosition=maskMatrix*worldPosition;panoPosition=panoMatrix2*panoMatrix1*worldPosition;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},5244:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetVisionAssets"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",alias:{kind:"Name",value:"objectBlur"},name:{kind:"Name",value:"asset"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"StringValue",value:"blurs/suggestions",block:!1}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"status"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"contentType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"filename"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"format"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"validUntil"},arguments:[],directives:[]},{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"BlurSuggestionAsset"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"version"},arguments:[],directives:[]}]}}]}}]}}]}}],loc:{start:0,end:383}};t.loc.source={body:'# Fetches public output files from the Vision Catalog,\n# only available after platform 21.21.1 release\nquery GetVisionAssets($modelId: ID!) {\n  model(id: $modelId) {\n    objectBlur: asset(id: "blurs/suggestions") {\n      id\n      status\n      contentType\n      filename\n      format\n      url\n      validUntil\n      ... on BlurSuggestionAsset {\n          version\n      }\n    }\n  }\n}\n',name:"GraphQL request",locationOffset:{line:1,column:1}};function s(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&t.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){s(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){s(e,t)})),e.definitions&&e.definitions.forEach((function(e){s(e,t)}))}var i={};function n(e,t){for(var s=0;s<e.definitions.length;s++){var i=e.definitions[s];if(i.name&&i.name.value==t)return i}}t.definitions.forEach((function(e){if(e.name){var t=new Set;s(e,t),i[e.name.value]=t}})),e.exports=t,e.exports.GetVisionAssets=function(e,t){var s={kind:e.kind,definitions:[n(e,t)]};e.hasOwnProperty("loc")&&(s.loc=e.loc);var a=i[t]||new Set,r=new Set,o=new Set;for(a.forEach((function(e){o.add(e)}));o.size>0;){var l=o;o=new Set,l.forEach((function(e){r.has(e)||(r.add(e),(i[e]||new Set).forEach((function(e){o.add(e)})))}))}return r.forEach((function(t){var i=n(e,t);i&&s.definitions.push(i)})),s}(t,"GetVisionAssets")},2942:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetVisionCatalog"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"assets"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"catalog"},arguments:[{kind:"Argument",name:{kind:"Name",value:"formats"},value:{kind:"ListValue",values:[{kind:"StringValue",value:"json",block:!1}]}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"format"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"type"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"contentType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"description"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"validUntil"},arguments:[],directives:[]}]}}]}}]}}]}}],loc:{start:0,end:290}};t.loc.source={body:'# Fetches Vision Catalog assets, restricted to staff users\nquery GetVisionCatalog($modelId: ID!) {\n  model(id: $modelId) {\n    assets {\n      catalog(formats: ["json"]) {\n        format\n        type\n        contentType\n        description\n        url\n        validUntil\n      }\n    }\n  }\n}\n',name:"GraphQL request",locationOffset:{line:1,column:1}};function s(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&t.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){s(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){s(e,t)})),e.definitions&&e.definitions.forEach((function(e){s(e,t)}))}var i={};function n(e,t){for(var s=0;s<e.definitions.length;s++){var i=e.definitions[s];if(i.name&&i.name.value==t)return i}}t.definitions.forEach((function(e){if(e.name){var t=new Set;s(e,t),i[e.name.value]=t}})),e.exports=t,e.exports.GetVisionCatalog=function(e,t){var s={kind:e.kind,definitions:[n(e,t)]};e.hasOwnProperty("loc")&&(s.loc=e.loc);var a=i[t]||new Set,r=new Set,o=new Set;for(a.forEach((function(e){o.add(e)}));o.size>0;){var l=o;o=new Set,l.forEach((function(e){r.has(e)||(r.add(e),(i[e]||new Set).forEach((function(e){o.add(e)})))}))}return r.forEach((function(t){var i=n(e,t);i&&s.definitions.push(i)})),s}(t,"GetVisionCatalog")}}]);